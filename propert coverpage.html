<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Cover Page Summary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body { 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
        }
        
        /* Interactive Hover Cues */
        .editable-field {
            transition: all 0.2s;
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }
        .editable-field:hover {
            background-color: #eff6ff;
            box-shadow: 0 0 0 1px #bfdbfe;
            cursor: text;
        }
        select.editable-field:hover {
            cursor: pointer;
        }

        /* Delete Row Button Logic */
        .coverage-row .delete-row-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .coverage-row:hover .delete-row-btn {
            opacity: 1;
        }

        /* Sidebar Scrollbar */
        .sidebar-scroll::-webkit-scrollbar { width: 6px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover { background-color: #9ca3af; }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .print-only-value {
            display: none;
        }

        /* SHEET STYLES */
        .sheet {
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            padding: 0.4in;
            min-height: 11in;
            width: 8.5in;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- BULLETPROOF PRINT STYLES --- */
        @media print {
            @page { margin: 0; size: letter portrait; }
            *, *::before, *::after {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
                text-shadow: none !important;
                box-shadow: none !important;
            }
            html, body {
                width: 100%; height: 100%; margin: 0 !important; padding: 0 !important;
                background: white !important; overflow: visible !important;
            }
            aside.sidebar, .no-print, button, .delete-row-btn { display: none !important; }
            main.main-content {
                width: 100% !important; height: auto !important; margin: 0 !important;
                padding: 0 !important; display: block !important; background: white !important;
                overflow: visible !important;
            }
            .sheet {
                box-shadow: none !important; margin: 0 !important; width: 100% !important;
                height: 11in !important; page-break-after: always !important;
                break-after: page !important; overflow: hidden !important;
            }
            .sheet:last-of-type { page-break-after: auto !important; break-after: auto !important; }
            input:not([type="checkbox"]), select, textarea { display: none !important; }
            .print-only-value { display: block !important; white-space: pre-wrap; }
            input[type="checkbox"] {
                appearance: none; -webkit-appearance: none; border: 1px solid black;
                width: 12px; height: 12px; display: inline-block !important;
                position: relative; top: 2px;
            }
            input[type="checkbox"]:checked {
                background-color: black; box-shadow: inset 0 0 0 2px white;
            }
            .print-only-value, p, h1, h2, h3, h4, h5, h6, span, div { color: #000 !important; }
            .bg-gray-800 .print-only-value, .bg-gray-800 span, .bg-gray-800 div, .bg-gray-800 input { color: white !important; }
            .break-inside-avoid { break-inside: avoid; }
            * { animation: none !important; transition: none !important; }
        }
    </style>
</head>
<body class="text-sm text-gray-900">

    <!-- LEFT SIDEBAR -->
    <aside class="sidebar w-80 bg-white border-r border-gray-200 flex flex-col shadow-xl z-20 h-full">
        <div class="p-5 bg-white border-b border-gray-100 shadow-sm z-10 shrink-0">
            <div class="mb-3">
                <a href="property.html" class="inline-flex items-center justify-center w-8 h-8 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition-all border border-indigo-200 hover:border-indigo-300 shadow-sm" title="Back to Property">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                </a>
            </div>
            <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                <div class="bg-indigo-600 text-white p-1 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                </div>
                Property Dashboard
            </h2>
            <p class="text-xs text-gray-400 mt-1 pl-1">Broker Configuration Tool</p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 sidebar-scroll bg-gray-50">
            <!-- Property Management -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-[10px] font-bold uppercase text-gray-400 tracking-wider flex items-center gap-1">
                        Locations
                    </label>
                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm" id="location-counter-badge">1</span>
                </div>
                <div id="sidebar-location-list" class="space-y-2 mb-3">
                    <!-- Dynamic Items Here -->
                </div>
                <button onclick="window.addProperty()" class="w-full border border-indigo-600 text-indigo-600 bg-indigo-50 py-2 rounded-lg font-bold hover:bg-indigo-100 transition flex items-center justify-center gap-2 text-xs cursor-pointer shadow-sm hover:shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    Add Property
                </button>
            </div>

            <!-- Endorsement Visibility Management -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <label class="block text-[10px] font-bold uppercase text-gray-400 tracking-wider mb-1">Standard Endorsements</label>
                <p class="text-[9px] text-gray-400 mb-3 italic">Toggling 'ON' shows and checks box</p>
                <div id="endorsements-list" class="space-y-1 mb-4">
                    <!-- Standard Checkbox Control List -->
                </div>

                <div class="pt-3 border-t border-gray-100">
                    <label class="block text-[10px] font-bold uppercase text-gray-400 tracking-wider mb-1">Water Coverages</label>
                    <div id="water-list" class="space-y-1 mb-4">
                        <!-- Water Checkbox Control List -->
                    </div>
                </div>

                <div class="pt-3 border-t border-gray-100">
                    <label class="block text-[10px] font-bold uppercase text-gray-400 tracking-wider mb-2">Custom Field</label>
                    <div class="flex gap-2">
                        <input type="text" id="custom-endo-name" placeholder="Name..." class="border border-gray-300 rounded-lg px-3 py-1.5 w-full text-xs outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200 transition-all bg-white" onkeydown="if(event.key==='Enter') window.addEndorsement()">
                        <button onclick="window.addEndorsement()" class="bg-gray-100 text-gray-600 rounded-lg px-3 py-1.5 text-xs font-bold hover:bg-indigo-600 hover:text-white transition-colors cursor-pointer border border-gray-200">+</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-gray-200 z-10 shrink-0">
            <button onclick="window.print()" class="w-full bg-gray-900 hover:bg-black text-white py-3.5 px-6 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3 cursor-pointer group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                Print / Save PDF
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="main-content flex-1 overflow-y-auto p-8 flex flex-col items-center" id="pages-container">
        <!-- JS WILL POPULATE SHEETS HERE -->
    </main>

    <!-- HIDDEN COMPONENT STAGING AREA -->
    <div id="staging-area" class="hidden">
        <!-- HEADER -->
        <div id="comp-header">
            <div class="border-b-2 border-black pb-4 mb-6">
                <div class="flex flex-col md:flex-row print:flex-row justify-between gap-6">
                    <div class="w-full md:w-1/2 print:w-1/2">
                        <h2 class="font-bold text-gray-700 uppercase text-[10px] tracking-wide mb-1">Broker Name, Email, Tel & Branch:</h2>
                        <input type="text" class="text-base font-bold uppercase w-full outline-none editable-field text-black" value="Eldho George">
                        <input type="text" class="w-full outline-none editable-field text-black" value="peldho.george@kmibrokers.com">
                        <input type="text" class="w-full outline-none editable-field text-black" value="437-422-8353 - InsLyf Mississauga">
                    </div>
                    <div class="w-full md:w-1/2 print:w-1/2 grid grid-cols-2 gap-x-4 gap-y-2 text-right md:text-left print:text-left">
                        <div><span class="block text-gray-500 text-[10px] uppercase tracking-wide">Policy/Binder#</span><input type="text" class="font-bold text-base w-full text-right md:text-left print:text-left outline-none bg-transparent placeholder-gray-400 editable-field text-black" value="B3938"></div>
                        <div><span class="block text-gray-500 text-[10px] uppercase tracking-wide">Effective Date</span><input type="date" class="font-bold w-full text-right md:text-left print:text-left outline-none bg-transparent cursor-pointer editable-field text-black" value="2025-11-21"></div>
                        <div><span class="block text-gray-500 text-[10px] uppercase tracking-wide">Insurance Company</span>
                            <select class="font-bold w-full text-right md:text-left print:text-left outline-none bg-transparent cursor-pointer editable-field text-black">
                                <option value="Unica Insurance" selected>Unica Insurance</option>
                                <option value="Optimum Insurance">Optimum Insurance</option>
                                <option value="Intact Insurance">Intact Insurance</option>
                                <option value="Aviva Insurance">Aviva Insurance</option>
                            </select>
                        </div>
                        <div><span class="block text-gray-500 text-[10px] uppercase tracking-wide">Policy Holder</span><input type="text" class="font-bold w-full text-right md:text-left print:text-left outline-none bg-transparent placeholder-gray-400 editable-field text-black" value="Mathew, Neethu & Vazhakala, Josis"></div>
                    </div>
                </div>
            </div>
            <div class="text-center mb-6">
                <h1 class="text-xl font-bold uppercase tracking-wide border-b-4 border-double border-gray-400 inline-block pb-1 text-black">Property Cover Page Summary</h1>
            </div>
        </div>

        <!-- TERMS PART 1 -->
        <div id="comp-terms-1" class="pt-4 border-t-2 border-black mt-2">
            <h3 class="font-bold border-b-2 border-gray-800 mb-3 text-sm uppercase text-black pb-1">Coverages Explained</h3>
            <div class="grid grid-cols-2 gap-x-8 text-xs leading-tight text-gray-700 text-justify">
                <div class="space-y-2">
                    <p><strong class="underline">Dwelling Protection:</strong> Structural safeguard against insured perils like fire, wind, or water.</p>
                    <p><strong class="underline">Personal Property Insurance:</strong> Coverage for loss/damage of personal belongings inside or outside dwelling.</p>
                    <p><strong class="underline">Outbuilding:</strong> Protection for detached structures (sheds, garages, barns, etc.).</p>
                </div>
                <div class="space-y-2">
                    <p><strong class="underline">Personal Liability Coverage:</strong> Defense and payment for claims where you are legally liable for injury or property damage.</p>
                    <p><strong class="underline">Policy Deductible:</strong> Your out-of-pocket share required before insurance coverage pays a claim.</p>
                </div>
            </div>
        </div>

        <!-- TERMS PART 2 -->
        <div id="comp-terms-2" class="pt-2">
             <div class="grid grid-cols-2 gap-x-8 text-xs leading-tight text-gray-700 text-justify">
                <div class="space-y-2">
                    <p><strong class="underline">Additional Living Expenses (ALE):</strong> Covers temporary housing and food costs if your residence is uninhabitable.</p>
                    <p><strong class="underline">Guaranteed Replacement Cost:</strong> Guarantees repair to full value at time of loss regardless of limits.</p>
                    <p><strong class="underline">Replacement Cost Contents:</strong> Replaces contents with new items without depreciation deductions.</p>
                </div>
                <div class="space-y-2">
                    <p><strong class="underline">Water Protection:</strong> Comprehensive protection including Sewer Back-up, Overland Water, and Ground Water.</p>
                    <p><strong class="underline">Service Line(s):</strong> Coverage for underground utility lines serving your home from the street.</p>
                </div>
            </div>
        </div>

        <!-- INITIALS BLOCK -->
        <div id="comp-initials">
            <div class="flex justify-end mt-auto pt-6">
                <div class="border border-black px-4 py-2 flex items-center gap-2">
                    <span class="font-bold text-xs uppercase text-black">Insured Initial(s):</span>
                    <input type="text" class="w-16 border-b border-black outline-none text-center bg-transparent editable-field text-black">
                </div>
            </div>
        </div>

        <!-- SIGNATURES BLOCK -->
        <div id="comp-signatures" class="border-t-2 border-black pt-6 mt-4">
            <p class="text-justify text-[10px] italic mb-6 leading-relaxed text-gray-700">
                I have read and understand the summary of key coverages within my application for Ontario Property Insurance. I recognize that this summary is only a cover page and is intended to be a helpful tool to explain the coverages that have been included or declined in my policy, but it is important that I carefully review all the details of the entire application.
            </p>
            <div class="grid grid-cols-1 gap-6">
                <div class="grid grid-cols-3 gap-8 items-end">
                    <div><input type="text" class="w-full border-b border-black outline-none bg-transparent font-serif editable-field text-black" placeholder="Enter Name"><p class="text-[9px] uppercase font-bold mt-1 text-gray-500">Policy Holder (Name)</p></div>
                    <div><div class="w-full border-b border-black h-6"></div><p class="text-[9px] uppercase font-bold mt-1 text-gray-500">Signatures</p></div>
                    <div><input type="text" class="w-full border-b border-black outline-none bg-transparent font-serif text-xs editable-field text-black"><p class="text-[9px] uppercase font-bold mt-1 text-gray-500">Date</p></div>
                </div>
            </div>
        </div>

        <!-- PROPERTY CARD STORAGE -->
        <div id="property-storage">
            <!-- Initial Card Template -->
            <div class="property-card border-2 border-black print-border break-inside-avoid shadow-sm mb-6" id="prop-1">
                <div class="bg-gray-800 text-white py-1.5 px-3 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-sm uppercase prop-label">Location 1</span>
                        <select onchange="window.handlePolicyTypeChange(this)" class="policy-type-select text-xs text-white bg-gray-700 border border-gray-600 px-2 py-0.5 rounded cursor-pointer outline-none font-bold no-print">
                            <option value="Homeowners">Homeowners</option>
                            <option value="Tenant">Tenant</option>
                            <option value="Condo">Condo</option>
                            <option value="Rented Dwelling">Rented Dwelling</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.removeProperty(1)" class="text-red-400 hover:text-red-300 transition-colors cursor-pointer p-1 no-print">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                        <input type="text" class="bg-transparent text-white font-bold uppercase text-right w-64 outline-none editable-field" value="123 MAIN ST, MISSISSAUGA">
                    </div>
                </div>
                
                <div class="p-3 bg-white">
                    <div class="grid grid-cols-2 gap-6 items-start">
                        <!-- Advanced Coverage Table -->
                        <table class="w-full text-[10px] border-collapse">
                            <thead>
                                <tr class="bg-gray-100 border-b border-black">
                                    <th class="text-left py-1 px-2 uppercase">Coverage</th>
                                    <th class="text-right py-1 px-2 uppercase" colspan="2">Limit/Deductible</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-300">
                                <tr class="coverage-row group" data-coverage="deductible">
                                    <td class="py-1 px-2">Policy Deductible</td>
                                    <td class="text-right py-1 px-2">
                                        <select class="font-bold text-right outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field">
                                            <option value="1000">1000</option>
                                            <option value="1500">1500</option>
                                            <option value="2000">2000</option>
                                            <option value="2500" selected>2500</option>
                                            <option value="3000">3000</option>
                                            <option value="5000">5000</option>
                                        </select>
                                    </td>
                                    <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                </tr>
                                <tr class="coverage-row group" data-coverage="liability">
                                    <td class="py-1 px-2">Liability Limit</td>
                                    <td class="text-right py-1 px-2">
                                        <select class="liability-select font-bold text-right outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field">
                                            <option value="$1,000,000">$1,000,000</option>
                                            <option value="$2,000,000" selected>$2,000,000</option>
                                        </select>
                                    </td>
                                    <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                </tr>
                                <tr class="coverage-row group" data-coverage="dwelling-building">
                                    <td class="py-1 px-2">Dwelling Limit Building</td>
                                    <td class="text-right py-1 px-2 flex items-center justify-end gap-0.5">
                                        <span class="currency-symbol font-bold">$</span>
                                        <input type="text" oninput="window.handleCurrencyLogic(this)" value="514,500" class="font-bold text-right w-20 outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field">
                                    </td>
                                    <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                </tr>
                                <tr class="coverage-row group" data-coverage="personal-property">
                                    <td class="py-1 px-2">Personal Property Limit</td>
                                    <td class="text-right py-1 px-2 flex items-center justify-end gap-0.5">
                                        <span class="currency-symbol font-bold hidden">$</span>
                                        <input type="text" oninput="window.handleCurrencyLogic(this)" value="Included" class="font-bold text-right w-20 outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field">
                                    </td>
                                    <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                </tr>
                                <tr class="coverage-row group" data-coverage="ale">
                                    <td class="py-1 px-2">Additional Living Expenses</td>
                                    <td class="text-right py-1 px-2 flex items-center justify-end gap-0.5">
                                        <span class="currency-symbol font-bold hidden">$</span>
                                        <input type="text" oninput="window.handleCurrencyLogic(this)" value="Included" class="font-bold text-right w-20 outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field">
                                    </td>
                                    <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="space-y-3">
                            <div class="endorsements-container grid grid-cols-2 gap-2 text-[9px] font-bold uppercase text-gray-700">
                                <!-- Dynamic Endorsements -->
                            </div>
                            <div class="border-t border-black pt-2 water-section">
                                <span class="text-[9px] font-bold uppercase text-indigo-700 block mb-1">Water Coverage:</span>
                                <div class="water-container grid grid-cols-3 gap-1 text-[8px] uppercase">
                                    <!-- Dynamic Water -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let propertyCounter = 1;
        
        let globalEndorsements = [
            { id: 'endo-grc', name: 'Guaranteed Building Replacement Cost', visible: true },
            { id: 'endo-rcc', name: 'Replacement Cost Contents', visible: false },
            { id: 'endo-rip', name: 'Rental Income Protection', visible: false },
            { id: 'endo-ns', name: 'Non-Smoker', visible: true }
        ];

        let waterCoverages = [
            { id: 'water-sb', name: 'Sewer Backup', visible: true },
            { id: 'water-ow', name: 'Overland Water', visible: true },
            { id: 'water-gw', name: 'Ground Water', visible: false },
            { id: 'water-aw', name: 'Above Water', visible: false },
            { id: 'water-sl', name: 'Sewer Lines', visible: false }
        ];

        // --- GLOBAL FUNCTIONS ---

        window.handlePolicyTypeChange = function(select) {
            const card = select.closest('.property-card');
            if (!card) return;
            
            const isTenant = select.value === 'Tenant';
            const dwellingRow = card.querySelector('tr[data-coverage="dwelling-building"]');
            const liabilitySelect = card.querySelector('.liability-select');

            if (isTenant) {
                // Default 1M Liability for Tenants
                if (liabilitySelect) liabilitySelect.value = '$1,000,000';
                // Hide Dwelling Building for Tenants
                if (dwellingRow) dwellingRow.style.display = 'none';
            } else {
                // Show Dwelling Building for others
                if (dwellingRow) dwellingRow.style.display = 'table-row';
            }
            
            updateMirror(select);
            if (liabilitySelect) updateMirror(liabilitySelect);
            paginate(); // Re-paginate to ensure correct height
        };

        window.handleCurrencyLogic = function(input) {
            const symbol = input.previousElementSibling;
            if (!symbol || !symbol.classList.contains('currency-symbol')) return;
            
            const val = input.value.toLowerCase().trim();
            const looksLikeText = val === 'included' || val === 'not included' || val === 'all' || val === 'n/a' || val === 'none';
            
            if (looksLikeText || val === '') {
                symbol.classList.add('hidden');
            } else {
                symbol.classList.remove('hidden');
            }
            updateMirror(input);
        };

        window.removeProperty = function(id) {
            if(!confirm(`Are you sure you want to remove Location ${id}?`)) return;
            const card = document.getElementById('prop-' + id);
            if (card) card.remove();
            setTimeout(() => { paginate(); updateSidebarUI(); }, 0);
        };

        window.removeTableRow = function(btn) {
            const row = btn.closest('.coverage-row');
            if (row) {
                row.remove();
                paginate();
            }
        };

        window.addProperty = function() {
            propertyCounter++;
            const storage = document.getElementById('property-storage');
            const template = `
                <div class="property-card border-2 border-black print-border break-inside-avoid shadow-sm mb-6 animate-fade-in" id="prop-${propertyCounter}">
                    <div class="bg-gray-800 text-white py-1.5 px-3 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-sm uppercase prop-label">Location ${propertyCounter}</span>
                            <select onchange="window.handlePolicyTypeChange(this)" class="policy-type-select text-xs text-white bg-gray-700 border border-gray-600 px-2 py-0.5 rounded cursor-pointer outline-none font-bold no-print">
                                <option value="Homeowners" selected>Homeowners</option>
                                <option value="Tenant">Tenant</option>
                                <option value="Condo">Condo</option>
                                <option value="Rented Dwelling">Rented Dwelling</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.removeProperty(${propertyCounter})" class="text-red-400 hover:text-red-300 transition-colors cursor-pointer p-1 no-print">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <input type="text" class="bg-transparent text-white font-bold uppercase text-right w-64 outline-none editable-field" placeholder="ENTER ADDRESS">
                        </div>
                    </div>
                    <div class="p-3 bg-white">
                        <div class="grid grid-cols-2 gap-6 items-start">
                            <table class="w-full text-[10px] border-collapse">
                                <tbody class="divide-y divide-gray-300">
                                    <tr class="coverage-row group" data-coverage="deductible">
                                        <td class="py-1 px-2">Policy Deductible</td>
                                        <td class="text-right py-1 px-2">
                                            <select class="font-bold text-right outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field">
                                                <option value="1000">1000</option><option value="1500">1500</option><option value="2000">2000</option><option value="2500" selected>2500</option><option value="3000">3000</option><option value="5000">5000</option>
                                            </select>
                                        </td>
                                        <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                    </tr>
                                    <tr class="coverage-row group" data-coverage="liability">
                                        <td class="py-1 px-2">Liability Limit</td>
                                        <td class="text-right py-1 px-2">
                                            <select class="liability-select font-bold text-right outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field">
                                                <option value="$1,000,000">$1,000,000</option><option value="$2,000,000" selected>$2,000,000</option>
                                            </select>
                                        </td>
                                        <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                    </tr>
                                    <tr class="coverage-row group" data-coverage="dwelling-building">
                                        <td class="py-1 px-2">Dwelling Limit Building</td>
                                        <td class="text-right py-1 px-2 flex items-center justify-end gap-0.5"><span class="currency-symbol font-bold">$</span><input type="text" oninput="window.handleCurrencyLogic(this)" value="0" class="font-bold text-right w-20 outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field"></td>
                                        <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                    </tr>
                                    <tr class="coverage-row group" data-coverage="personal-property">
                                        <td class="py-1 px-2">Personal Property Limit</td>
                                        <td class="text-right py-1 px-2 flex items-center justify-end gap-0.5"><span class="currency-symbol font-bold hidden">$</span><input type="text" oninput="window.handleCurrencyLogic(this)" value="Included" class="font-bold text-right w-20 outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field"></td>
                                        <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                    </tr>
                                    <tr class="coverage-row group" data-coverage="ale">
                                        <td class="py-1 px-2">Additional Living Expenses</td>
                                        <td class="text-right py-1 px-2 flex items-center justify-end gap-0.5"><span class="currency-symbol font-bold hidden">$</span><input type="text" oninput="window.handleCurrencyLogic(this)" value="Included" class="font-bold text-right w-20 outline-none bg-transparent border-b border-dashed border-gray-400 text-[10px] editable-field"></td>
                                        <td class="w-4 text-center"><button onclick="window.removeTableRow(this)" class="delete-row-btn text-red-500 p-1 no-print">×</button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="space-y-3">
                                <div class="endorsements-container grid grid-cols-2 gap-2 text-[9px] font-bold uppercase text-gray-700"></div>
                                <div class="border-t border-black pt-2 water-section">
                                    <span class="text-[9px] font-bold uppercase text-indigo-700 block mb-1">Water Coverage:</span>
                                    <div class="water-container grid grid-cols-3 gap-1 text-[8px] uppercase"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = template.trim();
            storage.appendChild(div.firstElementChild);
            renderAllFieldsToAllCards();
            paginate();
            updateSidebarUI();
        };

        window.addEndorsement = function() {
            const input = document.getElementById('custom-endo-name');
            const name = input.value.trim();
            if (!name) return;
            const id = 'endo-' + Date.now();
            globalEndorsements.push({ id, name, visible: true });
            input.value = '';
            renderAllFieldsToAllCards();
            updateSidebarLists();
            paginate();
        };

        window.toggleVisibility = function(group, id, isVisible) {
            const targetArray = group === 'water' ? waterCoverages : globalEndorsements;
            const index = targetArray.findIndex(e => e.id === id);
            if (index !== -1) {
                targetArray[index].visible = isVisible;
                renderAllFieldsToAllCards();
                paginate();
            }
        };

        // --- INTERNAL HELPERS ---

        function renderAllFieldsToAllCards() {
            const cards = document.querySelectorAll('.property-card');
            cards.forEach(card => {
                const endoContainer = card.querySelector('.endorsements-container');
                endoContainer.innerHTML = globalEndorsements
                    .filter(e => e.visible)
                    .map(e => `<label class="flex items-center gap-1"><input type="checkbox" checked> ${e.name}</label>`).join('');

                const waterContainer = card.querySelector('.water-container');
                const visibleWater = waterCoverages.filter(e => e.visible);
                const waterSection = card.querySelector('.water-section');
                if (waterSection) waterSection.style.display = visibleWater.length > 0 ? 'block' : 'none';
                waterContainer.innerHTML = visibleWater
                    .map(e => `<label class="flex items-center gap-1"><input type="checkbox" checked> ${e.name}</label>`).join('');
            });
        }

        function updateSidebarLists() {
            const endoList = document.getElementById('endorsements-list');
            endoList.innerHTML = globalEndorsements.map(e => `
                <div class="flex items-center gap-2 bg-gray-50 p-1.5 px-2 rounded text-[11px] text-gray-700 border border-gray-100">
                    <input type="checkbox" ${e.visible ? 'checked' : ''} onchange="window.toggleVisibility('standard', '${e.id}', this.checked)" class="rounded text-indigo-600">
                    <span class="font-medium">${e.name}</span>
                </div>
            `).join('');

            const waterList = document.getElementById('water-list');
            waterList.innerHTML = waterCoverages.map(e => `
                <div class="flex items-center gap-2 bg-gray-50 p-1.5 px-2 rounded text-[11px] text-gray-700 border border-gray-100">
                    <input type="checkbox" ${e.visible ? 'checked' : ''} onchange="window.toggleVisibility('water', '${e.id}', this.checked)" class="rounded text-indigo-600">
                    <span class="font-medium">${e.name}</span>
                </div>
            `).join('');
        }

        function paginate() {
            const container = document.getElementById('pages-container');
            const staging = document.getElementById('staging-area');
            const storage = document.getElementById('property-storage');

            const components = ['comp-header', 'comp-terms-1', 'comp-terms-2', 'comp-signatures', 'comp-initials'];
            components.forEach(id => { const el = document.getElementById(id); if (el) staging.appendChild(el); });

            const cards = Array.from(document.querySelectorAll('.property-card'));
            cards.sort((a, b) => parseInt(a.id.replace('prop-', '')) - parseInt(b.id.replace('prop-', '')));
            
            cards.forEach((card, index) => {
                const newIdx = index + 1;
                card.querySelector('.prop-label').textContent = `Location ${newIdx}`;
                storage.appendChild(card);
            });

            container.innerHTML = '';
            const allCards = Array.from(storage.children);
            const count = allCards.length;

            const header = document.getElementById('comp-header');
            const t1 = document.getElementById('comp-terms-1');
            const t2 = document.getElementById('comp-terms-2');
            const sig = document.getElementById('comp-signatures');
            const ini = document.getElementById('comp-initials');

            let page1 = createSheet();
            container.appendChild(page1);
            page1.appendChild(header);

            for (let i = 0; i < Math.min(count, 2); i++) page1.appendChild(allCards[i]);

            if (count === 1) {
                page1.appendChild(t1);
                page1.appendChild(ini);
                ini.style.marginTop = 'auto';
                let page2 = createSheet();
                container.appendChild(page2);
                page2.appendChild(t2);
                page2.appendChild(sig);
                page2.appendChild(cloneInitials());
            } else {
                page1.appendChild(ini);
                ini.style.marginTop = 'auto';
                let pageN = createSheet();
                container.appendChild(pageN);
                const remaining = allCards.slice(2);
                remaining.forEach(c => {
                    if (pageN.querySelectorAll('.property-card').length >= 2) {
                        pageN.appendChild(cloneInitials());
                        pageN = createSheet();
                        container.appendChild(pageN);
                    }
                    pageN.appendChild(c);
                });
                if (pageN.querySelectorAll('.property-card').length >= 2) {
                    pageN.appendChild(cloneInitials());
                    pageN = createSheet();
                    container.appendChild(pageN);
                }
                pageN.appendChild(t1);
                pageN.appendChild(t2);
                pageN.appendChild(sig);
                pageN.appendChild(cloneInitials());
            }
            document.getElementById('location-counter-badge').textContent = count;
            
            document.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(el => updateMirror(el));
        }

        function updateSidebarUI() {
            const list = document.getElementById('sidebar-location-list');
            list.innerHTML = Array.from(document.querySelectorAll('.property-card')).map((card, index) => {
                const idNum = card.id.replace('prop-', '');
                return `
                    <div id="sidebar-prop-${idNum}" class="flex justify-between items-center bg-gray-50 p-2.5 rounded-lg border border-gray-100 animate-fade-in">
                        <div class="flex items-center gap-2">
                            <span class="h-2 w-2 rounded-full bg-green-500 shadow-sm"></span>
                            <span class="text-xs font-bold text-gray-700">Location ${index + 1}</span>
                        </div>
                        <button onclick="window.removeProperty(${idNum})" class="text-red-400 hover:text-red-600 transition-colors p-1" title="Remove Location">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function createSheet() { const div = document.createElement('div'); div.className = 'sheet'; return div; }

        function cloneInitials() {
            const clone = document.getElementById('comp-initials').cloneNode(true);
            clone.id = ''; clone.style.marginTop = 'auto';
            clone.querySelectorAll('input').forEach(i => {
                i.value = '';
                i.addEventListener('input', (e) => updateMirror(e.target));
            });
            return clone;
        }

        function updateMirror(input) {
            if (input.type === 'checkbox') return;
            let mirror = input.nextElementSibling;
            if (!mirror || !mirror.classList.contains('print-only-value')) {
                mirror = document.createElement('div');
                mirror.className = 'print-only-value ' + input.className;
                mirror.classList.remove('editable-field', 'outline-none', 'bg-transparent', 'placeholder-gray-400', 'cursor-pointer', 'border-b', 'border-dashed');
                mirror.style.minHeight = '1.2em';
                input.parentNode.insertBefore(mirror, input.nextSibling);
            }
            if (input.tagName === 'SELECT') {
                const selectedOption = input.options[input.selectedIndex];
                mirror.textContent = selectedOption ? selectedOption.text : '';
            } else {
                mirror.textContent = input.value;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderAllFieldsToAllCards();
            updateSidebarLists();
            paginate();
            updateSidebarUI();
            document.addEventListener('input', (e) => { if(e.target.matches('input, textarea')) updateMirror(e.target); });
            document.addEventListener('change', (e) => { if(e.target.matches('select')) updateMirror(e.target); });
        });
    </script>
</body>
</html>