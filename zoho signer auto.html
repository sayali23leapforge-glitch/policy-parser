<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrokerFlow - Auto Signer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configuration -->
    <script>
        const CONFIG = {
            PDF_WORKER_URL: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js',
            KEYS: { PRESETS: 'bf_layouts_v2', BROKER: 'bf_profile_v2' },
            THEME: {
                colors: {
                    zoho: { blue: '#0069ff', dark: '#0f172a', light: '#f1f5f9' }
                },
                animation: {
                    'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                }
            }
        };

        pdfjsLib.GlobalWorkerOptions.workerSrc = CONFIG.PDF_WORKER_URL;
        
        tailwind.config = {
            theme: { extend: CONFIG.THEME }
        }
    </script>

    <style>
        body { overflow: hidden; }
        .page-wrapper {
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            background-color: white;
            margin-bottom: 20px; 
            flex-shrink: 0; 
        }
        .the-canvas { display: block; width: 100%; height: 100%; }
        
        /* Draggable Items (Sidebar) */
        .field-item { cursor: grab; transition: all 0.2s; border-width: 1px; }
        .field-item:active { cursor: grabbing; }

        /* Dropped Fields (Canvas) */
        .dropped-field {
            position: absolute;
            background: rgba(239, 246, 255, 0.95); /* Default Blue-50 */
            border: 2px solid #2563eb; /* Blue-600 */
            color: #1e40af; /* Blue-800 */
            font-weight: 800;
            font-size: 11px;
            display: flex; align-items: center; justify-content: center;
            cursor: grab; 
            user-select: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-radius: 6px; overflow: hidden; white-space: nowrap; z-index: 10; 
            letter-spacing: 0.5px;
        }
        .dropped-field:active { cursor: grabbing; z-index: 60; }
        .dropped-field:hover { z-index: 50; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.15); border-width: 2px; }
        
        /* Broker Field Variant */
        .dropped-field.role-broker {
            background: rgba(250, 245, 255, 0.95); /* Purple-50 */
            border-color: #9333ea; /* Purple-600 */
            color: #6b21a8; /* Purple-800 */
        }

        .dropped-field .delete-btn {
            position: absolute; top: 0; right: 0; 
            background: #ef4444; color: white;
            border-bottom-left-radius: 4px; width: 18px; height: 18px;
            display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer;
        }
        .dropped-field:hover .delete-btn { display: flex; }

        /* Template Items */
        .template-item { transition: all 0.2s; }
        .template-item:hover { background-color: #f8fafc; border-color: #cbd5e1; }
        .template-item.active { background-color: #eff6ff; border-color: #4f46e5; border-left-width: 3px; }
        
        /* Category Tabs */
        .cat-tab { transition: all 0.2s; position: relative; }
        .cat-tab.active { color: #4f46e5; background-color: #e0e7ff; }

        /* Role Tints for Drop Zone */
        .tint-client { background-color: #eff6ff; } /* Blue tint */
        .tint-broker { background-color: #faf5ff; } /* Purple tint */
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col text-slate-900" onclick="closeMenu(event)">

    <!-- Navbar -->
    <header class="bg-white border-b border-slate-200 h-14 flex items-center justify-between px-4 shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 text-white p-1.5 rounded-lg shadow-sm">
                <i class="fa-solid fa-robot text-xs"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold leading-tight text-slate-700">Broker<span class="text-indigo-600">Flow</span></h1>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200 mr-auto ml-8">
            <button onclick="switchView('autosigner')" id="nav-autosigner" class="px-4 py-1 text-[11px] font-bold rounded-md bg-white text-indigo-600 shadow-sm transition-all">
                <i class="fa-solid fa-pen-nib mr-1.5"></i> Auto Signer
            </button>
            <button onclick="switchView('documents')" id="nav-documents" class="px-4 py-1 text-[11px] font-bold rounded-md text-slate-500 hover:text-slate-700 transition-all">
                <i class="fa-solid fa-file-invoice mr-1.5"></i> Sent Docs
            </button>
        </div>
        
        <!-- Action Area (Auto Signer) -->
        <div id="header-actions-autosigner" class="flex gap-2 items-center">
            <input type="file" id="as-file-upload" accept="application/pdf" class="hidden" />
            
            <div id="as-msg-select" class="flex items-center px-3 py-1.5 text-[11px] font-bold text-slate-400 bg-slate-100 rounded-md border border-slate-200">
                <i class="fa-solid fa-arrow-left mr-2"></i> Select a Form to Start
            </div>

            <div id="as-action-group" class="hidden flex gap-2 items-center">
                <div class="text-right mr-1 hidden md:block">
                    <div id="active-form-label" class="text-[11px] font-bold text-slate-700 leading-tight max-w-[120px] truncate">Form</div>
                    <div id="active-mode-label" class="text-[9px] uppercase font-bold text-slate-400 leading-tight">Mode</div>
                </div>
                
                <!-- SETUP: Delete Template Config -->
                <button id="as-delete-config-btn" onclick="deleteTemplateConfig()" class="hidden w-7 h-7 flex items-center justify-center text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 rounded-md transition" title="Delete Saved Overlay">
                    <i class="fa-solid fa-trash-alt text-xs"></i>
                </button>

                <!-- RUN: Clear Document -->
                <button id="as-clear-doc-btn" onclick="clearLoadedDocument()" class="hidden flex items-center gap-1.5 px-3 py-1.5 text-[11px] font-bold text-red-600 bg-red-50 border border-red-100 rounded-md hover:bg-red-100 transition shadow-sm" title="Clear Document & Start Over">
                    <i class="fa-solid fa-times"></i> Clear
                </button>

                <!-- RUN: Upload Button -->
                <button id="as-upload-btn" onclick="document.getElementById('as-file-upload').click()" class="hidden flex items-center gap-1.5 px-3 py-1.5 text-[11px] font-bold text-slate-600 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition shadow-sm">
                    <i class="fa-solid fa-upload"></i> Upload
                </button>

                <button id="as-main-btn" onclick="executeAutoSignerAction()" class="flex items-center gap-2 px-4 py-1.5 text-[11px] font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition shadow-sm">
                      Action
                </button>
            </div>
        </div>

        <!-- Action Area (Documents) -->
        <div id="header-actions-documents" class="hidden flex gap-2 items-center">
             <button onclick="showListApiSpecs()" class="flex items-center gap-2 px-4 py-1.5 text-[11px] font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 rounded-md hover:bg-indigo-100 transition shadow-sm uppercase tracking-wide">
                <i class="fa-solid fa-database"></i> API Specs
            </button>
        </div>

        <button onclick="openSettings()" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-full transition ml-1" title="Broker Settings">
            <i class="fa-solid fa-cog text-xs"></i>
        </button>
    </header>

    <!-- Main Application Area -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- === VIEW: AUTO SIGNER === -->
        <div id="view-autosigner" class="flex flex-1 overflow-hidden w-full h-full absolute inset-0">
             <!-- LEFT SIDEBAR: OPTIMIZED FOR DENSITY -->
            <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shadow-sm z-10 shrink-0 text-sm">
                
                <!-- Compact Header: Tabs + Menu Combined -->
                <div class="p-2 bg-white relative border-b border-slate-100 flex items-center gap-2 shrink-0">
                    
                    <!-- Category Tabs (Grow) -->
                    <div class="flex flex-1 bg-slate-100 p-0.5 rounded-lg border border-slate-200">
                        <button onclick="switchCategory('auto')" id="tab-cat-auto" class="flex-1 py-1 text-[10px] font-bold rounded-md transition-all shadow-sm bg-indigo-600 text-white">Auto</button>
                        <button onclick="switchCategory('property')" id="tab-cat-property" class="flex-1 py-1 text-[10px] font-bold rounded-md transition-all text-slate-500 hover:bg-slate-200">Prop</button>
                    </div>

                    <!-- Three Dots Menu (Compact) -->
                    <div class="relative shrink-0">
                        <button onclick="event.stopPropagation(); toggleMenu()" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition">
                            <i class="fa-solid fa-ellipsis"></i>
                        </button>
                        <div id="mode-menu" class="hidden absolute right-0 top-8 w-48 bg-white border border-slate-200 shadow-xl rounded-xl z-50 overflow-hidden ring-1 ring-black/5">
                            <button id="menu-item-run" onclick="switchAutoMode('run')" class="hidden w-full text-left px-4 py-3 text-xs font-bold text-slate-600 hover:bg-slate-50 hover:text-indigo-600 flex items-center gap-3 transition">
                                <div class="w-6 h-6 rounded-md bg-indigo-50 text-indigo-600 flex items-center justify-center"><i class="fa-solid fa-play"></i></div>
                                <span>Run Mode</span>
                            </button>
                            <button id="menu-item-setup" onclick="switchAutoMode('setup')" class="w-full text-left px-4 py-3 text-xs font-bold text-slate-600 hover:bg-slate-50 hover:text-amber-600 flex items-center gap-3 transition">
                                <div class="w-6 h-6 rounded-md bg-amber-50 text-amber-600 flex items-center justify-center"><i class="fa-solid fa-wrench"></i></div>
                                <span>Setup Templates</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hidden elements for state preservation -->
                    <span id="mode-title" class="hidden">Run Auto</span>
                </div>
                
                <!-- Setup Indicator (Only shows in setup mode, compact) -->
                <div id="setup-indicator" class="hidden bg-amber-500 text-white text-[9px] font-bold text-center py-0.5 uppercase tracking-widest shrink-0">
                    Setup Mode
                </div>
    
                <!-- Form List -->
                <div class="flex-1 overflow-y-auto px-2 py-2 bg-slate-50/50">
                    <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5 pl-1">Forms</h3>
                    <div id="as-form-list" class="space-y-1"></div>
                </div>
    
                <!-- Compact Palette & Signer Tools -->
                <div id="as-palette" class="h-auto max-h-[55%] border-t border-slate-200 bg-white p-2 overflow-y-auto flex flex-col shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.05)] z-20">
                    
                    <!-- Signer Config Block (Improved Colors) -->
                    <div id="signer-config-container" class="mb-2 border-b border-slate-100 pb-2">
                        <div class="flex items-center justify-between mb-1">
                            <h3 class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Assign To:</h3>
                            <span class="text-[8px] font-bold text-slate-300" id="role-hint">Toggle</span>
                        </div>
                        
                        <!-- Role Toggle -->
                        <div class="flex gap-1 mb-2">
                            <button onclick="setRole('client')" id="btn-role-client" class="flex-1 py-1 text-[10px] font-bold rounded-md bg-blue-600 text-white shadow-md border border-blue-700 flex items-center justify-center gap-1 transition-all active:scale-95">
                                <i class="fa-solid fa-user"></i> Client
                            </button>
                            <button onclick="setRole('broker')" id="btn-role-broker" class="flex-1 py-1 text-[10px] font-bold rounded-md bg-slate-100 text-slate-400 border border-slate-200 flex items-center justify-center gap-1 transition-all hover:bg-slate-200">
                                <i class="fa-solid fa-user-tie"></i> Broker
                            </button>
                        </div>
    
                        <!-- Inputs (Run Mode Only - Sidebar) -->
                        <div id="run-mode-inputs" class="space-y-1 hidden animate-fade-in">
                            <div class="relative group">
                                <span class="absolute left-2.5 top-2 text-slate-400 text-[10px] group-focus-within:text-blue-500 transition"><i class="fa-solid fa-signature"></i></span>
                                <input type="text" id="signer-name" placeholder="Signer Name" class="w-full text-[10px] border border-slate-200 rounded-md py-1.5 pl-7 pr-2 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-slate-50 focus:bg-white" oninput="updateSignerInfo()">
                            </div>
                            <div class="relative group">
                                <span class="absolute left-2.5 top-2 text-slate-400 text-[10px] group-focus-within:text-blue-500 transition"><i class="fa-solid fa-at"></i></span>
                                <input type="email" id="signer-email" placeholder="Signer Email" class="w-full text-[10px] border border-slate-200 rounded-md py-1.5 pl-7 pr-2 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-slate-50 focus:bg-white" oninput="updateSignerInfo()">
                            </div>
                        </div>
                    </div>
    
                    <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5 pl-1">
                        Fields
                    </h3>
                    
                    <div class="grid grid-cols-3 gap-1">
                         <!-- Action Fields -->
                         <div class="field-item flex flex-col items-center justify-center gap-0.5 p-1 border border-slate-200 rounded-lg hover:border-blue-400 hover:shadow-md cursor-grab bg-white transition-all group" draggable="true" data-type="Signature">
                            <div class="w-6 h-6 rounded-md bg-blue-50 text-blue-600 flex items-center justify-center text-[10px] group-hover:bg-blue-600 group-hover:text-white transition-colors"><i class="fa-solid fa-pen-nib"></i></div>
                            <span class="text-[9px] font-bold text-slate-600 group-hover:text-slate-800">Sign</span>
                        </div>
                        <div class="field-item flex flex-col items-center justify-center gap-0.5 p-1 border border-slate-200 rounded-lg hover:border-purple-400 hover:shadow-md cursor-grab bg-white transition-all group" draggable="true" data-type="Sign Date">
                            <div class="w-6 h-6 rounded-md bg-purple-50 text-purple-600 flex items-center justify-center text-[10px] group-hover:bg-purple-600 group-hover:text-white transition-colors"><i class="fa-solid fa-calendar-check"></i></div>
                            <span class="text-[9px] font-bold text-slate-600 group-hover:text-slate-800">Date</span>
                        </div>
                        <div class="field-item flex flex-col items-center justify-center gap-0.5 p-1 border border-slate-200 rounded-lg hover:border-emerald-400 hover:shadow-md cursor-grab bg-white transition-all group" draggable="true" data-type="Initial">
                            <div class="w-6 h-6 rounded-md bg-emerald-50 text-emerald-600 flex items-center justify-center text-[10px] group-hover:bg-emerald-600 group-hover:text-white transition-colors"><i class="fa-solid fa-italic"></i></div>
                            <span class="text-[9px] font-bold text-slate-600 group-hover:text-slate-800">Init</span>
                        </div>
    
                        <!-- Data Fields -->
                        <div class="field-item flex flex-col items-center justify-center gap-0.5 p-1 border border-slate-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 cursor-grab bg-white transition-all group" draggable="true" data-type="Company">
                            <i class="fa-solid fa-building text-[10px] text-slate-400 group-hover:text-indigo-600"></i>
                            <span class="text-[9px] font-bold text-slate-500 group-hover:text-indigo-600">Comp</span>
                        </div>
                         <div class="field-item flex flex-col items-center justify-center gap-0.5 p-1 border border-slate-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 cursor-grab bg-white transition-all group" draggable="true" data-type="Full Name">
                            <i class="fa-solid fa-user text-[10px] text-slate-400 group-hover:text-indigo-600"></i>
                            <span class="text-[9px] font-bold text-slate-500 group-hover:text-indigo-600">Name</span>
                        </div>
                         <div class="field-item flex flex-col items-center justify-center gap-0.5 p-1 border border-slate-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 cursor-grab bg-white transition-all group" draggable="true" data-type="Email">
                            <i class="fa-solid fa-envelope text-[10px] text-slate-400 group-hover:text-indigo-600"></i>
                            <span class="text-[9px] font-bold text-slate-500 group-hover:text-indigo-600">Email</span>
                        </div>
                         <div class="field-item flex flex-col items-center justify-center gap-0.5 p-1 border border-slate-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 cursor-grab bg-white transition-all group" draggable="true" data-type="Date">
                            <i class="fa-regular fa-calendar-days text-[10px] text-slate-400 group-hover:text-indigo-600"></i>
                            <span class="text-[9px] font-bold text-slate-500 group-hover:text-indigo-600">Date</span>
                        </div>
                         <div class="field-item flex flex-col items-center justify-center gap-0.5 p-1 border border-slate-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 cursor-grab bg-white transition-all group" draggable="true" data-type="Text">
                            <i class="fa-solid fa-font text-[10px] text-slate-400 group-hover:text-indigo-600"></i>
                            <span class="text-[9px] font-bold text-slate-500 group-hover:text-indigo-600">Text</span>
                        </div>
                    </div>
                </div>
            </aside>
    
            <!-- RIGHT CANVAS: PDF & Overlays -->
            <div class="flex-1 bg-slate-100 overflow-auto p-8 flex justify-center scroll-smooth relative transition-colors duration-300" id="as-drop-zone">
                
                <!-- Empty State -->
                <div id="as-empty-state" class="text-center mt-32 opacity-50">
                    <div class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-4 text-indigo-300 text-2xl border border-indigo-50">
                        <i class="fa-solid fa-arrow-pointer"></i>
                    </div>
                    <h3 class="text-sm font-bold text-slate-600" id="as-empty-title">Ready</h3>
                    <p class="text-[10px] text-slate-400 mt-1" id="as-empty-desc">Select form to begin.</p>
                </div>
    
                <!-- PDF Container -->
                <div id="as-pages-container" class="hidden flex flex-col items-center pb-32 w-full gap-4"></div>
            </div>
        </div>

        <!-- === VIEW: DOCUMENTS LIST === -->
        <div id="view-documents" class="flex-1 overflow-y-auto p-8 hidden bg-slate-50 w-full h-full absolute inset-0">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Policy Status</h2>
                        <p class="text-sm text-slate-500 mt-1">Manage all out-for-signature policy documents.</p>
                    </div>
                    <div class="flex gap-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-indigo-600" id="stat-total">0</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Total Policies</div>
                        </div>
                        <div class="text-center border-l pl-6 border-slate-200">
                            <div class="text-2xl font-bold text-orange-500 animate-pulse-slow" id="stat-inprogress">0</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Awaiting Action</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50/50 border-b border-slate-200 text-[10px] uppercase text-slate-400 font-black tracking-widest">
                                <th class="px-8 py-5">Policy Name</th>
                                <th class="px-8 py-5">Signers & Status</th>
                                <th class="px-8 py-5">Global Status</th>
                                <th class="px-8 py-5">Expiring</th>
                                <th class="px-8 py-5 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documents-table-body" class="text-sm text-slate-700 divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- === MODALS === -->

    <!-- Add Master File Modal -->
    <div id="add-master-modal" class="fixed inset-0 bg-slate-900/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden m-4 p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-1">New Template</h3>
            <p class="text-[10px] text-slate-500 mb-4">Adding to <span id="add-modal-category" class="font-bold text-indigo-600">Auto</span> category.</p>
            <input type="text" id="new-master-name" placeholder="Template Name" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-xs focus:ring-2 focus:ring-indigo-500 outline-none mb-5">
            <div class="flex gap-2">
                <button onclick="document.getElementById('add-master-modal').classList.add('hidden')" class="flex-1 py-2.5 text-slate-400 font-bold text-[10px] uppercase tracking-wider hover:bg-slate-50 rounded-lg transition">Cancel</button>
                <button onclick="confirmAddMaster()" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-bold text-xs shadow-md hover:bg-indigo-700 transition">Create</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-slate-900/40 z-[70] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden m-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">Settings</h3>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Broker Name</label>
                    <input type="text" id="broker-name" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-xs outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Broker Email</label>
                    <input type="email" id="broker-email" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-xs outline-none focus:border-indigo-500">
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full mt-6 py-2.5 bg-slate-800 text-white rounded-lg font-bold text-xs hover:bg-slate-900 transition">Save</button>
        </div>
    </div>

    <!-- Status Modal -->
    <div id="status-modal" class="fixed inset-0 bg-slate-900/40 z-[200] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 text-center animate-bounce-in">
            <div id="status-icon" class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-check"></i></div>
            <h3 id="status-title" class="font-bold text-lg text-slate-800 mb-1">Done!</h3>
            <p id="status-message" class="text-xs text-slate-500 mb-5 px-2 leading-relaxed"></p>
            <button onclick="document.getElementById('status-modal').classList.add('hidden')" class="w-full py-2.5 bg-slate-100 text-slate-600 rounded-lg font-bold text-xs transition hover:bg-slate-200">Dismiss</button>
        </div>
    </div>

    <!-- Developer Handoff Modal (JSON Output) -->
    <div id="json-modal" class="fixed inset-0 bg-slate-900/60 z-[100] hidden flex items-center justify-center backdrop-blur-md">
        <div class="bg-white rounded-3xl shadow-2xl w-3/4 max-w-4xl max-h-[85vh] flex flex-col overflow-hidden">
            <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg text-slate-800">Zoho API Integration Guide</h3>
                    <p class="text-xs text-slate-500">Target Endpoint: <span class="font-mono text-indigo-600">POST https://sign.zoho.com/api/v1/requests</span></p>
                </div>
                <button onclick="document.getElementById('json-modal').classList.add('hidden')" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-600 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="bg-indigo-50 p-4 flex gap-4 text-[11px] border-b border-indigo-100">
                <div class="flex-1">
                    <strong class="text-indigo-800 block mb-1 uppercase tracking-tighter">Content-Type</strong>
                    <code class="text-slate-600">multipart/form-data</code>
                </div>
                <div class="flex-1 border-l pl-4 border-indigo-200">
                    <strong class="text-indigo-800 block mb-1 uppercase tracking-tighter">Keys Required</strong>
                    <code class="text-slate-600">file</code> (PDF) & <code class="text-slate-600">data</code> (JSON)
                </div>
            </div>

            <div class="flex-1 overflow-hidden relative">
                <textarea id="json-output" class="w-full h-full p-6 font-mono text-[11px] text-indigo-900 bg-white resize-none focus:outline-none" readonly></textarea>
            </div>
            <div class="p-6 border-t bg-slate-50 flex justify-end gap-3">
                <button onclick="copyToClipboard('json-output')" class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-md hover:bg-indigo-700 transition">Copy Payload</button>
            </div>
        </div>
    </div>
    
    <!-- Download Modal -->
    <div id="download-modal" class="fixed inset-0 bg-slate-900/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden m-4">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800 tracking-tight">Retrieve Document</h3>
                <button onclick="document.getElementById('download-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="download-request-id">
                <label class="flex items-center gap-4 p-4 border rounded-2xl hover:bg-slate-50 cursor-pointer transition">
                    <input type="checkbox" id="dl-with-coc" class="w-5 h-5 text-indigo-600 rounded-lg" checked>
                    <div>
                        <div class="text-sm font-bold text-slate-700">Include Audit Certificate (CoC)</div>
                        <div class="text-[10px] text-slate-400 uppercase font-black tracking-widest">Required for Compliance</div>
                    </div>
                </label>
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Developer GET Request</div>
                <div class="bg-slate-900 text-indigo-300 p-4 rounded-2xl font-mono text-[10px] break-all border border-slate-700" id="dl-api-url">...</div>
            </div>
            <div class="p-6 border-t bg-slate-50">
                <button onclick="generateDownloadUrl()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-sm shadow-lg">Copy Download Link</button>
            </div>
        </div>
    </div>

    <!-- API Info Modal (List) -->
    <div id="list-api-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-3/4 max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b bg-slate-50 flex justify-between">
                <div>
                    <h3 class="font-bold text-lg text-slate-800">Developer Handoff (Fetch & Actions)</h3>
                    <p class="text-xs text-slate-500">API Documentation for retrieval and reminders.</p>
                </div>
                <button onclick="document.getElementById('list-api-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <strong class="block text-xs uppercase text-slate-400 mb-2">Get List (GET)</strong>
                        <div class="space-y-2 text-[10px] font-mono">
                            <div class="bg-slate-50 p-2 border rounded">row_count: Int (1...n)</div>
                            <div class="bg-slate-50 p-2 border rounded">start_index: Int (1...n)</div>
                            <div class="bg-slate-50 p-2 border rounded">sort_column: created_time | request_name</div>
                        </div>
                    </div>
                    <div>
                        <strong class="block text-xs uppercase text-slate-400 mb-2">Send Reminder (POST)</strong>
                        <div class="space-y-2 text-[10px] font-mono">
                            <div class="bg-indigo-50 p-2 border border-indigo-200 rounded text-indigo-700 font-bold tracking-tight">POST /api/v1/requests/{id}/remind</div>
                            <div class="bg-slate-50 p-2 border rounded">No body required. Authentication via header.</div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="border rounded p-3 bg-slate-900 text-slate-300 font-mono text-[11px] overflow-auto">
                        <span class="text-indigo-400 uppercase font-bold">// Download PDF</span><br>
                        https://sign.zoho.com/api/v1/requests/{request_id}/pdf?with_coc=true&merge=true
                    </div>
                    <div class="border rounded p-3 bg-slate-900 text-slate-300 font-mono text-[11px] overflow-auto">
                        <span class="text-indigo-400 uppercase font-bold">// Download COC Only</span><br>
                        https://sign.zoho.com/api/v1/requests/{request_id}/completioncertificate
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-end">
                <button onclick="document.getElementById('list-api-modal').classList.add('hidden')" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-medium transition hover:bg-indigo-700">Close</button>
            </div>
        </div>
    </div>

    <script>
    // --- STATE MANAGEMENT ---
    const STATE = {
        autoMode: 'run', // 'run' or 'setup'
        currentCategory: 'auto',
        selectedFormName: null,
        isDocLoaded: false,
        activeSignerRole: 'client', // 'client' or 'broker'
        currentSigners: { client: {name:'', email:''}, broker: {name:'', email:''} },
        asDroppedFields: [],
        draggedType: null,
        isMovingExisting: false,
        draggedFieldId: null,
        dragOffsetX: 0,
        dragOffsetY: 0
    };

    const TYPE_API_MAP = { Signature:'Signature', Initial:'Initial', Date:'Date', 'Sign Date':'Date', 'Full Name':'Name', Text:'Textfield', Company:'Company', Email:'Email' };
        
    // --- DEFAULT FORMS CONFIG ---
    const DEFAULT_FORMS = {
        auto: ["Ontario Automobile Application", "PAC Form (Auto)", "Personal Information Consent (Auto)", "AB Options Buyup Report", "Auto Cover Page"],
        property: ["Property Cover Page", "Non-Smoker Declaration", "Personal Information Consent (Hab)", "Habitational Insurance Application", "PAC Form (Property)"]
    };

    // --- INIT ---
    window.onload = function() {
        if (!localStorage.getItem(CONFIG.KEYS.PRESETS)) {
            let seed = {};
            Object.keys(DEFAULT_FORMS).forEach(cat => {
                DEFAULT_FORMS[cat].forEach(name => { seed[name] = { category: cat, data: [] }; });
            });
            localStorage.setItem(CONFIG.KEYS.PRESETS, JSON.stringify(seed));
        }
        
        // Load Broker Profile into State
        const profile = JSON.parse(localStorage.getItem(CONFIG.KEYS.BROKER) || '{}');
        if(profile.name) document.getElementById('broker-name').value = profile.name;
        if(profile.email) document.getElementById('broker-email').value = profile.email;
        STATE.currentSigners.broker.name = profile.name || '';
        STATE.currentSigners.broker.email = profile.email || '';

        renderFormList();
        
        // Initialize Inputs for Default Role
        setRole('client');
        switchAutoMode('run'); // Force initialization
    };

    // --- UI SWITCHING ---
    function switchView(view) {
        document.getElementById('view-autosigner').classList.toggle('hidden', view !== 'autosigner');
        document.getElementById('view-documents').classList.toggle('hidden', view !== 'documents');
        document.getElementById('header-actions-autosigner').classList.toggle('hidden', view !== 'autosigner');
        document.getElementById('header-actions-documents').classList.toggle('hidden', view !== 'documents');

        ['nav-autosigner','nav-documents'].forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                const active = id.includes(view);
                btn.className = active ? 'px-4 py-1 text-[11px] font-bold rounded-md bg-white text-indigo-600 shadow-sm transition-all' : 'px-4 py-1 text-[11px] font-bold rounded-md text-slate-500 hover:text-slate-700 transition-all';
            }
        });
        if (view === 'documents') renderDocumentsTable();
    }

    function switchAutoMode(mode) {
        STATE.autoMode = mode;
        const title = document.getElementById('mode-title');
        const indicator = document.getElementById('setup-indicator');
        const runTools = document.getElementById('run-mode-inputs'); // Sidebar inputs
        
        // Menu Items
        const menuRun = document.getElementById('menu-item-run');
        const menuSetup = document.getElementById('menu-item-setup');
        
        if(mode === 'run') {
            if (title) title.textContent = "Run Auto";
            if (indicator) indicator.classList.add('hidden');
            if (runTools) runTools.classList.remove('hidden');
            
            if(menuRun) menuRun.classList.add('hidden');
            if(menuSetup) menuSetup.classList.remove('hidden');
        } else {
            if (title) title.textContent = "Template Setup";
            if (indicator) indicator.classList.remove('hidden');
            if (runTools) runTools.classList.add('hidden');
            
            if(menuRun) menuRun.classList.remove('hidden');
            if(menuSetup) menuSetup.classList.add('hidden');
        }

        renderFormList(); // Re-render to show Add/Delete button logic
        if(STATE.selectedFormName) updateActionHeader();
        
        // Close menu
        const menu = document.getElementById('mode-menu');
        if(menu) menu.classList.add('hidden');
    }

    function setRole(role) {
        STATE.activeSignerRole = role;
        
        // Update Toggle Styles
        const btnClient = document.getElementById('btn-role-client');
        const btnBroker = document.getElementById('btn-role-broker');
        
        const activeClassClient = "flex-1 py-1 text-[10px] font-bold rounded-md bg-blue-600 text-white shadow-sm border border-blue-700 flex items-center justify-center gap-1 transition-all active:scale-95";
        const inactiveClassClient = "flex-1 py-1 text-[10px] font-bold rounded-md bg-slate-100 text-slate-400 border border-slate-200 flex items-center justify-center gap-1 transition-all hover:bg-slate-100";
        
        const activeClassBroker = "flex-1 py-1 text-[10px] font-bold rounded-md bg-purple-600 text-white shadow-sm border border-purple-700 flex items-center justify-center gap-1 transition-all active:scale-95";
        const inactiveClassBroker = "flex-1 py-1 text-[10px] font-bold rounded-md bg-slate-50 text-slate-400 border border-slate-200 flex items-center justify-center gap-1 transition-all hover:bg-slate-100";
        
        // Update Background Tint for Drop Zone
        const dropZone = document.getElementById('as-drop-zone');

        if (role === 'client') {
            btnClient.className = activeClassClient;
            btnBroker.className = inactiveClassBroker;
            dropZone.classList.remove('tint-broker');
            dropZone.classList.add('tint-client');
        } else {
            btnBroker.className = activeClassBroker;
            btnClient.className = inactiveClassClient;
            dropZone.classList.remove('tint-client');
            dropZone.classList.add('tint-broker');
        }
        
        // Update Inputs
        document.getElementById('signer-name').value = STATE.currentSigners[role].name;
        document.getElementById('signer-email').value = STATE.currentSigners[role].email;
    }
    
    function updateSignerInfo() {
        STATE.currentSigners[STATE.activeSignerRole].name = document.getElementById('signer-name').value;
        STATE.currentSigners[STATE.activeSignerRole].email = document.getElementById('signer-email').value;
    }

    function toggleMenu() { document.getElementById('mode-menu').classList.toggle('hidden'); }
    
    function closeMenu(e) {
        if(!e.target.closest('#mode-menu') && !e.target.closest('button[onclick*="toggleMenu"]')) {
             document.getElementById('mode-menu').classList.add('hidden');
        }
    }

    function switchCategory(cat) {
        STATE.currentCategory = cat;
        // Styling Updates for Tabs
        const tabAuto = document.getElementById('tab-cat-auto');
        const tabProp = document.getElementById('tab-cat-property');
        
        const activeTabClass = "flex-1 py-1 text-[10px] font-bold rounded-md transition-all shadow-sm bg-indigo-600 text-white";
        const inactiveTabClass = "flex-1 py-1 text-[10px] font-bold rounded-md transition-all text-slate-500 hover:bg-slate-200";

        if(cat === 'auto') {
            tabAuto.className = activeTabClass;
            tabProp.className = inactiveTabClass;
        } else {
            tabProp.className = activeTabClass;
            tabAuto.className = inactiveTabClass;
        }
        renderFormList();
    }

    function renderFormList() {
        const list = document.getElementById('as-form-list');
        list.innerHTML = '';
        const db = JSON.parse(localStorage.getItem(CONFIG.KEYS.PRESETS) || '{}');

        const formNames = Object.keys(db).filter(name => {
            const item = db[name];
            const cat = item.category || 'auto';
            return cat === STATE.currentCategory;
        }).sort();

        formNames.forEach(name => {
            const isConfigured = db[name] && db[name].data && db[name].data.length > 0;
            const isSelected = (name === STATE.selectedFormName);
            const div = document.createElement('div');
            
            // Compact list item style
            div.className = `template-item px-2 py-1.5 border rounded-md cursor-pointer mb-1 flex justify-between items-center transition-all ${isSelected ? 'active border-indigo-600 bg-indigo-50 shadow-sm' : 'border-slate-100 bg-white hover:border-indigo-200'}`;
            div.onclick = () => selectForm(name);
            
            let iconClass = isConfigured ? 'fa-circle-check text-green-500' : 'fa-circle text-slate-200';
            let deleteBtnHTML = '';
            
            if(STATE.autoMode === 'setup') {
                deleteBtnHTML = `<button onclick="event.stopPropagation(); deleteMasterFile('${name}')" class="w-5 h-5 flex items-center justify-center text-slate-300 hover:text-red-500 rounded hover:bg-red-50 transition"><i class="fa-solid fa-trash text-[10px]"></i></button>`;
            } else if(isSelected) {
                deleteBtnHTML = '<i class="fa-solid fa-chevron-right text-indigo-600 text-[10px]"></i>';
            }

            div.innerHTML = `
                <div class="flex items-center gap-2 overflow-hidden">
                    <i class="fa-regular ${iconClass} text-[10px]"></i>
                    <span class="text-[10px] font-bold text-slate-600 truncate">${name}</span>
                </div>
                ${deleteBtnHTML}
            `;
            list.appendChild(div);
        });

        if(STATE.autoMode === 'run') {
            const otherDiv = document.createElement('div');
            const isOtherSelected = (STATE.selectedFormName === 'Other Document');
            otherDiv.className = `template-item px-2 py-1.5 border border-dashed border-slate-300 rounded-md cursor-pointer mb-1 flex justify-between items-center transition-all ${isOtherSelected ? 'active border-indigo-600 bg-indigo-50 shadow-sm' : 'bg-slate-50 hover:border-indigo-300'}`;
            otherDiv.onclick = () => selectForm('Other Document');
            
            otherDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-file-circle-plus text-slate-400 text-[10px]"></i>
                    <span class="text-[10px] font-bold text-slate-500">Other / Ad-hoc File</span>
                </div>
                ${isOtherSelected ? '<i class="fa-solid fa-upload text-indigo-600 text-[10px] animate-bounce"></i>' : ''}
            `;
            list.appendChild(otherDiv);
        }

        if(STATE.autoMode === 'setup') {
            const addBtn = document.createElement('button');
            addBtn.className = 'w-full py-1.5 border border-dashed border-slate-200 rounded-md text-slate-400 text-[10px] font-bold hover:border-indigo-400 hover:text-indigo-600 transition flex items-center justify-center gap-1 mt-2 uppercase tracking-wide';
            addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> New Master';
            addBtn.onclick = addNewForm;
            list.appendChild(addBtn);
        }
    }

    function addNewForm() {
        document.getElementById('new-master-name').value = '';
        document.getElementById('add-modal-category').textContent = STATE.currentCategory.charAt(0).toUpperCase() + STATE.currentCategory.slice(1);
        document.getElementById('add-master-modal').classList.remove('hidden');
        document.getElementById('new-master-name').focus();
    }

    function confirmAddMaster() {
        const name = document.getElementById('new-master-name').value.trim();
        if(!name) return;
        const db = JSON.parse(localStorage.getItem(CONFIG.KEYS.PRESETS) || '{}');
        if(db[name]) { alert("Exists already."); return; }
        db[name] = { category: STATE.currentCategory, data: [] };
        localStorage.setItem(CONFIG.KEYS.PRESETS, JSON.stringify(db));
        document.getElementById('add-master-modal').classList.add('hidden');
        renderFormList();
        selectForm(name);
    }

    function deleteMasterFile(name) {
        if(!confirm(`Delete "${name}"?`)) return;
        const db = JSON.parse(localStorage.getItem(CONFIG.KEYS.PRESETS) || '{}');
        delete db[name];
        localStorage.setItem(CONFIG.KEYS.PRESETS, JSON.stringify(db));
        if(STATE.selectedFormName === name) {
            STATE.selectedFormName = null;
            resetAutoSignerState();
            document.getElementById('as-msg-select').classList.remove('hidden');
            document.getElementById('as-action-group').classList.add('hidden');
        }
        renderFormList();
    }

    function selectForm(name) {
        resetAutoSignerState();
        STATE.selectedFormName = name;
        renderFormList();
        document.getElementById('as-msg-select').classList.add('hidden');
        document.getElementById('as-action-group').classList.remove('hidden');
        
        const fileInput = document.getElementById('as-file-upload');
        if (name === 'Other Document') {
            fileInput.setAttribute('multiple', 'true');
        } else {
            fileInput.removeAttribute('multiple');
        }

        updateActionHeader();
        setTimeout(() => { fileInput.click(); }, 50);
    }

    function updateActionHeader() {
        const btn = document.getElementById('as-main-btn');
        const deleteConfigBtn = document.getElementById('as-delete-config-btn');
        const clearDocBtn = document.getElementById('as-clear-doc-btn');
        const uploadBtn = document.getElementById('as-upload-btn');
        
        document.getElementById('active-form-label').textContent = STATE.selectedFormName;
        const title = document.getElementById('as-empty-title');
        const desc = document.getElementById('as-empty-desc');

        // Defaults
        deleteConfigBtn.classList.add('hidden');
        clearDocBtn.classList.add('hidden');
        uploadBtn.classList.add('hidden');

        if(STATE.autoMode === 'setup') {
            document.getElementById('active-mode-label').textContent = "Setup";
            document.getElementById('active-mode-label').className = "text-[9px] uppercase font-bold text-amber-600";
            
            btn.className = 'flex items-center gap-2 px-4 py-1.5 text-[11px] font-bold text-white bg-amber-600 rounded-md hover:bg-amber-700 transition shadow-sm';
            btn.innerHTML = '<i class="fa-solid fa-snowflake"></i> Freeze & Discard PDF';
            deleteConfigBtn.classList.remove('hidden');
            
            title.textContent = "Setup: " + STATE.selectedFormName;
            desc.textContent = "Uploading Master PDF...";
        } else {
            document.getElementById('active-mode-label').textContent = "Run";
            document.getElementById('active-mode-label').className = "text-[9px] uppercase font-bold text-indigo-600";
            
            btn.className = 'flex items-center gap-2 px-4 py-1.5 text-[11px] font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition shadow-sm';
            btn.innerHTML = '<i class="fa-solid fa-bolt"></i> Process';
            
            if (!STATE.isDocLoaded) {
                 uploadBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Upload';
                 uploadBtn.classList.remove('hidden');
            } else {
                if(STATE.selectedFormName === 'Other Document') {
                    uploadBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add';
                    uploadBtn.classList.remove('hidden');
                } else {
                    clearDocBtn.classList.remove('hidden');
                }
            }
            title.textContent = "Run: " + STATE.selectedFormName;
            desc.textContent = STATE.selectedFormName === 'Other Document' ? "Uploading Multiple Files..." : "Uploading Customer PDF...";
        }
    }

    function clearLoadedDocument() {
        if(!confirm("Clear current document?")) return;
        resetAutoSignerState();
        setTimeout(() => { document.getElementById('as-file-upload').click(); }, 300);
    }

    function executeAutoSignerAction() {
        if(!STATE.selectedFormName) return alert("Select form first.");

        if(STATE.autoMode === 'setup') {
            const isLoaded = document.querySelectorAll('#as-pages-container .page-wrapper').length > 0;
            if(!isLoaded && STATE.asDroppedFields.length === 0) return alert("Upload Master PDF first.");
            
            const db = JSON.parse(localStorage.getItem(CONFIG.KEYS.PRESETS) || '{}');
            const blueprint = STATE.asDroppedFields.map(f => {
                 const wEl = document.getElementById('as-wrapper-'+f.page);
                 if(!wEl) return null;
                 return { type: f.type, x_pct: (f.x / wEl.offsetWidth) * 100, y_pct: (f.y / wEl.offsetHeight) * 100, page: f.page, w_pct: (f.width / wEl.offsetWidth) * 100, h_pct: (f.height / wEl.offsetHeight) * 100, role: f.role };
            }).filter(x => x);

            db[STATE.selectedFormName] = { category: STATE.currentCategory, data: blueprint };
            localStorage.setItem(CONFIG.KEYS.PRESETS, JSON.stringify(db));

            const canvases = document.querySelectorAll('#as-pages-container canvas');
            canvases.forEach(c => c.remove());
            renderFormList();
            showStatus("Saved", "Coordinates frozen.", "fa-check");

        } else {
            const isLoaded = document.querySelectorAll('#as-pages-container .page-wrapper').length > 0;
            if(!isLoaded) return alert("Upload document first.");
            
            const client = STATE.currentSigners.client;
            if(!client.name) return alert("Enter Client Name.");
            if(!client.email) return alert("Enter Client Email.");

            // Get the uploaded PDF file
            const fileInput = document.getElementById('as-file-upload');
            if (!fileInput.files || fileInput.files.length === 0) return alert("No file loaded.");
            
            const pdfFile = fileInput.files[0];
            
            // Submit form to backend
            submitFormToBackend(pdfFile);
        }
    }

    function generateZohoPayload() {
        // Prepare Actions
        const actions = [];
        
        // 1. Client Action (if fields exist)
        const clientFields = STATE.asDroppedFields.filter(f => f.role === 'client');
        if (clientFields.length > 0) {
            const cFields = mapFieldsToZoho(clientFields);
            actions.push({
                action_type: "SIGN",
                recipient_name: STATE.currentSigners.client.name,
                recipient_email: STATE.currentSigners.client.email,
                verify_recipient: true,
                verification_type: "EMAIL",
                signing_order: 0,
                fields: cFields
            });
        }

        // 2. Broker Action (if fields exist)
        const brokerFields = STATE.asDroppedFields.filter(f => f.role === 'broker');
        if (brokerFields.length > 0) {
            const bFields = mapFieldsToZoho(brokerFields);
            actions.push({
                action_type: "SIGN",
                recipient_name: STATE.currentSigners.broker.name,
                recipient_email: STATE.currentSigners.broker.email,
                signing_order: 1, // Broker signs second usually
                fields: bFields
            });
        }

        if (actions.length === 0) return alert("No fields placed to sign.");

        const payload = {
            requests: {
                request_name: STATE.selectedFormName + " - " + STATE.currentSigners.client.name,
                is_sequential: true,
                actions: actions
            }
        };

        // Show Modal
        document.getElementById('json-output').value = JSON.stringify(payload, null, 4);
        document.getElementById('json-modal').classList.remove('hidden');
    }

    async function submitFormToBackend(pdfFile) {
        // Submit form data to backend for processing
        try {
            const formData = new FormData();
            
            // Add PDF file
            formData.append('pdf_file', pdfFile);
            
            // Add form fields
            formData.append('form_name', STATE.selectedFormName || 'Unknown Form');
            formData.append('signer_email', STATE.currentSigners.client.email);
            formData.append('signer_name', STATE.currentSigners.client.name);
            formData.append('broker_email', STATE.currentSigners.broker.email);
            formData.append('broker_name', STATE.currentSigners.broker.name);
            
            // Send to backend
            const response = await fetch('/process-form', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showStatus('Form Submitted', `Form ID: ${result.form_id}\nStatus: ${result.status}`, 'fa-check');
                return result;
            } else {
                showStatus('Submission Failed', result.error || 'Unknown error', 'fa-exclamation-circle');
                return null;
            }
        } catch (error) {
            console.error('Submission error:', error);
            showStatus('Error', error.message, 'fa-exclamation-circle');
            return null;
        }
    }

    function mapFieldsToZoho(fieldsList) {
        const zFields = { text_fields:[], image_fields:[], date_fields:[], check_boxes:[], file_fields:[] };
        
        fieldsList.forEach(f => {
            const wrapper = document.querySelector(`.page-wrapper[data-page-num="${f.page}"]`);
            if(!wrapper) return; 

            const fieldObj = {
                field_name: f.type + "_" + f.id.slice(-4),
                field_type_name: TYPE_API_MAP[f.type] || 'Textfield',
                page_no: f.page - 1, // Zoho is 0-indexed
                x_coord: Math.round(f.x), 
                y_coord: Math.round(f.y),
                abs_width: Math.round(f.width),
                abs_height: Math.round(f.height),
                is_mandatory: true
            };
            
            // Map to specific arrays
            if (['Signature', 'Initial'].includes(f.type)) zFields.image_fields.push(fieldObj);
            else if (['Date', 'Sign Date'].includes(f.type)) zFields.date_fields.push(fieldObj);
            else if (f.type === 'Checkbox') {
                fieldObj.default_value = "false";
                zFields.check_boxes.push(fieldObj);
            }
            else zFields.text_fields.push(fieldObj); 
        });

        // Cleanup empty arrays
        Object.keys(zFields).forEach(k => {
            if (zFields[k].length === 0) delete zFields[k];
        });
        
        return zFields;
    }
    
    function deleteTemplateConfig() { 
        if(!STATE.selectedFormName) return;
        if(confirm(`Reset configuration for "${STATE.selectedFormName}"?`)) {
             const db = JSON.parse(localStorage.getItem(CONFIG.KEYS.PRESETS) || '{}');
             if(db[STATE.selectedFormName]) {
                 db[STATE.selectedFormName].data = [];
                 localStorage.setItem(CONFIG.KEYS.PRESETS, JSON.stringify(db));
                 resetAutoSignerState();
                 renderFormList();
                 showStatus("Reset", "Overlay configuration cleared.", "fa-undo");
                 selectForm(STATE.selectedFormName);
             }
        }
    }

    function resetAutoSignerState() {
        STATE.isDocLoaded = false;
        STATE.asDroppedFields = [];
        document.getElementById('as-pages-container').innerHTML = '';
        document.getElementById('as-pages-container').classList.add('hidden');
        document.getElementById('as-empty-state').classList.remove('hidden');
        document.getElementById('as-file-upload').value = '';
        updateActionHeader();
    }

    // --- PDF HANDLING ---
    document.getElementById('as-file-upload').addEventListener('change', async function(e) {
        const files = e.target.files;
        if(!files || files.length === 0) return;

        if(STATE.selectedFormName !== 'Other Document') {
             STATE.asDroppedFields = [];
             document.getElementById('as-pages-container').innerHTML = '';
        }

        document.getElementById('as-empty-state').classList.add('hidden');
        document.getElementById('as-pages-container').classList.remove('hidden');
        
        let globalPageOffset = document.querySelectorAll('.page-wrapper').length;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileId = 'doc_' + Date.now() + '_' + i;
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(new Uint8Array(arrayBuffer)).promise;
                
                await renderPages(pdf, globalPageOffset, file.name, fileId);
                globalPageOffset += pdf.numPages;
                STATE.isDocLoaded = true;

            } catch(err) {
                console.error("PDF Load Error:", err);
                alert("Could not load PDF. It might be corrupted or password protected.");
            }
        }
        
        document.getElementById('as-file-upload').value = ''; 
        updateActionHeader(); 
        
        if(STATE.selectedFormName && STATE.selectedFormName !== 'Other Document') {
            applySavedOverlay(STATE.selectedFormName);
        } else if (STATE.selectedFormName === 'Other Document') {
            showStatus("Multi-Doc Loaded", "Documents merged. Drag fields manually.", "fa-layer-group");
        }
    });

    async function renderPages(pdf, pageOffset, filename, fileId) {
        const mainContainer = document.getElementById('as-pages-container');
        
        const docContainer = document.createElement('div');
        docContainer.id = fileId;
        docContainer.className = "w-full";
        
        if(STATE.selectedFormName === 'Other Document') {
            const header = document.createElement('div');
            header.className = "flex items-center justify-between bg-slate-100 p-2 rounded-t-lg border border-slate-200 border-b-0";
            header.innerHTML = `
                <div class="flex items-center gap-2 text-[10px] font-bold text-slate-700">
                    <i class="fa-solid fa-file-pdf text-red-500"></i> ${filename}
                </div>
                <button onclick="removeDocument('${fileId}', ${pageOffset + 1}, ${pageOffset + pdf.numPages})" class="text-slate-400 hover:text-red-500 transition px-2">
                    <i class="fa-solid fa-trash text-xs"></i>
                </button>
            `;
            docContainer.appendChild(header);
        }

        const pagesBody = document.createElement('div');
        const roundedClass = STATE.selectedFormName === 'Other Document' ? 'rounded-b-lg' : 'rounded-lg';
        pagesBody.className = `border border-slate-200 ${roundedClass} bg-slate-50/50 p-4 flex flex-col items-center gap-4`;
        docContainer.appendChild(pagesBody);

        mainContainer.appendChild(docContainer);

        for (let n = 1; n <= pdf.numPages; n++) {
            const page = await pdf.getPage(n);
            const vp = page.getViewport({scale: 1.3});
            
            const globalPageNum = pageOffset + n;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper'; 
            wrapper.setAttribute('data-page-num', globalPageNum);
            wrapper.id = 'as-wrapper-' + globalPageNum;
            wrapper.style.width = vp.width+'px'; 
            wrapper.style.height = vp.height+'px';
            
            const canvas = document.createElement('canvas');
            canvas.className = 'the-canvas'; canvas.height = vp.height; canvas.width = vp.width;
            wrapper.appendChild(canvas);
            pagesBody.appendChild(wrapper);
            
            wrapper.addEventListener('dragover', (e) => { e.preventDefault(); });
            wrapper.addEventListener('drop', (e) => handleDropWrapper(e, wrapper, globalPageNum));
            
            await page.render({canvasContext: canvas.getContext('2d'), viewport: vp}).promise;
        }
    }
    
    window.removeDocument = function(id, startPage, endPage) {
        const el = document.getElementById(id);
        if(el) {
            el.remove();
            STATE.asDroppedFields = STATE.asDroppedFields.filter(f => f.page < startPage || f.page > endPage);
            const container = document.getElementById('as-pages-container');
            if(container.children.length === 0) {
               document.getElementById('as-empty-state').classList.remove('hidden');
               document.getElementById('as-pages-container').classList.add('hidden');
               STATE.isDocLoaded = false;
               updateActionHeader();
            }
        }
    }

    function applySavedOverlay(name) {
        const db = JSON.parse(localStorage.getItem(CONFIG.KEYS.PRESETS) || '{}');
        if(name === 'Other Document') return;

        const data = db[name]?.data;
        if(!data || data.length === 0) return;

        data.forEach(bp => {
            const wrapper = document.getElementById('as-wrapper-'+bp.page);
            if (wrapper) {
                const w = (bp.w_pct/100) * wrapper.offsetWidth;
                const h = (bp.h_pct/100) * wrapper.offsetHeight;
                const x = (bp.x_pct/100) * wrapper.offsetWidth;
                const y = (bp.y_pct/100) * wrapper.offsetHeight;
                
                const field = { 
                    id: Date.now().toString()+Math.random(), 
                    type: bp.type, 
                    x, y, width: w, height: h, page: bp.page, 
                    role: bp.role || 'client' 
                };
                STATE.asDroppedFields.push(field);
                renderFieldDOM(field, wrapper);
            }
        });
    }

    // --- DRAG & DROP ---
    document.querySelectorAll('.field-item').forEach(item => {
        item.addEventListener('dragstart', (e) => { 
            STATE.draggedType = item.getAttribute('data-type');
            STATE.isMovingExisting = false; 
        });
    });

    function handleDropWrapper(e, wrapper, pageNum) {
        e.preventDefault();
        const rect = wrapper.getBoundingClientRect();
        const x = Math.round((e.clientX - rect.left) / 10) * 10;
        const y = Math.round((e.clientY - rect.top) / 10) * 10;
        
        if (STATE.isMovingExisting) {
            const f = STATE.asDroppedFields.find(f => f.id === STATE.draggedFieldId);
            if(f) {
                f.x = x - STATE.dragOffsetX;
                f.y = y - STATE.dragOffsetY;
                f.page = pageNum;
                const oldEl = document.getElementById(f.id);
                if(oldEl) oldEl.remove();
                renderFieldDOM(f, wrapper);
            }
            STATE.isMovingExisting = false;
        } else {
            const field = { 
                id: Date.now().toString(), 
                type: STATE.draggedType, 
                x: x - 60, y: y - 14, width: 120, height: 28, page: pageNum,
                role: STATE.activeSignerRole 
            };
            STATE.asDroppedFields.push(field);
            renderFieldDOM(field, wrapper);
        }
    }

    function renderFieldDOM(f, wrapper) {
        const el = document.createElement('div');
        el.id = f.id;
        el.className = `dropped-field ${f.role === 'broker' ? 'role-broker' : ''}`;
        el.setAttribute('draggable', true);
        el.style.left = f.x + 'px'; el.style.top = f.y + 'px';
        el.style.width = f.width + 'px'; el.style.height = f.height + 'px';
        
        el.addEventListener('dragstart', (e) => {
            e.stopPropagation();
            STATE.isMovingExisting = true;
            STATE.draggedFieldId = f.id;
            const rect = el.getBoundingClientRect();
            STATE.dragOffsetX = e.clientX - rect.left;
            STATE.dragOffsetY = e.clientY - rect.top;
        });

        const roleLabel = f.role === 'broker' ? ' (B)' : ' (C)';
        const btn = `<div class="delete-btn" onclick="deleteField('${f.id}')"><i class="fa-solid fa-times"></i></div>`;
        el.innerHTML = `<i class="fa-solid fa-tag mr-1 opacity-30 text-[8px]"></i> <span class="truncate">${f.type}${roleLabel}</span> ${btn}`;
        wrapper.appendChild(el);
    }
    
    window.deleteField = function(id) {
        STATE.asDroppedFields = STATE.asDroppedFields.filter(x => x.id !== id);
        const el = document.getElementById(id);
        if(el) el.remove();
    }

    // --- LIST VIEW FUNCTIONS ---
    function renderDocumentsTable() {
        const tbody = document.getElementById('documents-table-body');
        if (!tbody) return;
        
        const mock = [
            { request_name: "Premium Auto Policy #9822", request_status: "inprogress", sign_percentage: 33, request_id: "RID_9822", expire_by: Date.now()+864000000, actions: [{ recipient_name: "Sarah Miller", action_status: "SIGNED" }, { recipient_name: "John Doe", action_status: "UNOPENED" }] },
            { request_name: "Home Insurance Binder #4410", request_status: "inprogress", sign_percentage: 0, request_id: "RID_4410", expire_by: Date.now()+999000000, actions: [{ recipient_name: "Mike Ross", action_status: "UNOPENED" }] }
        ];

        tbody.innerHTML = '';
        document.getElementById('stat-total').textContent = mock.length;
        document.getElementById('stat-inprogress').textContent = mock.length;

        mock.forEach(doc => {
            const row = `<tr class="hover:bg-slate-50 transition border-b border-slate-100 font-medium text-slate-600">
                <td class="px-8 py-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-red-50 text-red-500 flex items-center justify-center text-xl shadow-sm"><i class="fa-solid fa-file-pdf"></i></div>
                        <div>
                            <div class="font-bold text-slate-800 text-sm">${doc.request_name}</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter mt-0.5">ID: ${doc.request_id}</div>
                        </div>
                    </div>
                </td>
                <td class="px-8 py-6">${doc.actions.map(a=>`<div class="flex items-center gap-2 mb-1.5"><div class="w-1.5 h-1.5 rounded-full ${a.action_status==='SIGNED'?'bg-green-500':'bg-slate-300'}"></div><span class="text-xs">${a.recipient_name}</span></div>`).join('')}</td>
                <td class="px-8 py-6"><span class="px-3 py-1 rounded-full bg-amber-100 text-amber-600 text-[10px] font-black uppercase tracking-widest border border-amber-200 animate-pulse-slow">In Progress</span></td>
                <td class="px-8 py-6 text-xs text-slate-400 font-bold">${new Date(doc.expire_by).toLocaleDateString()}</td>
                <td class="px-8 py-6 text-right">
                    <div class="flex justify-end gap-2">
                        <button onclick="sendRemind('${doc.request_id}')" class="w-9 h-9 flex items-center justify-center bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-600 hover:text-white transition shadow-sm" title="Send Reminder"><i class="fa-solid fa-bell"></i></button>
                        <button onclick="openDL('${doc.request_id}')" class="w-9 h-9 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-600 hover:text-white transition shadow-sm" title="Download"><i class="fa-solid fa-download"></i></button>
                    </div>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function sendRemind(id) { showStatus("Reminder Sent", "Successfully triggered the Zoho reminder API for this document.", "fa-paper-plane"); }
    function openDL(id) { document.getElementById('download-request-id').value = id; document.getElementById('download-modal').classList.remove('hidden'); updateDL(); }
    function updateDL() { const rid = document.getElementById('download-request-id').value; document.getElementById('dl-api-url').textContent = `https://sign.zoho.com/api/v1/requests/${rid}/pdf?with_coc=true`; }
    
    function generateDownloadUrl() { 
        copyToClipboard('dl-api-url'); 
        showStatus("API Link Copied", "Developer can use this GET request to fetch the PDF binary.", "fa-link"); 
    }
    
    // --- UTILS ---
    function saveSettings() {
        const profile = { name: document.getElementById('broker-name').value, email: document.getElementById('broker-email').value };
        localStorage.setItem(CONFIG.KEYS.BROKER, JSON.stringify(profile));
        STATE.currentSigners.broker.name = profile.name;
        STATE.currentSigners.broker.email = profile.email;
        if(STATE.activeSignerRole === 'broker') setRole('broker');
        document.getElementById('settings-modal').classList.add('hidden');
    }
    function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
    function showStatus(t, m, i) {
        document.getElementById('status-title').textContent = t;
        document.getElementById('status-message').textContent = m;
        document.getElementById('status-icon').innerHTML = `<i class="fa-solid ${i}"></i>`;
        document.getElementById('status-modal').classList.remove('hidden');
    }
    function showListApiSpecs() { document.getElementById('list-api-modal').classList.remove('hidden'); }
    
    function copyToClipboard(id) {
        const el = document.getElementById(id);
        if (!el) return;
        
        // Modern approach
        if (navigator.clipboard && navigator.clipboard.writeText) {
             navigator.clipboard.writeText(el.value || el.textContent)
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    // Fallback
                    el.select();
                    document.execCommand('copy');
                });
        } else {
            // Fallback for older environments
            el.select();
            document.execCommand('copy');
        }
    }
    </script>
</body>
</html>