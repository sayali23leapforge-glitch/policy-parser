<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker HUD - Property</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 850: '#151e2e' } }
                }
            }
        }
    </script>

    <style>
        /* --- BEM: Base Input --- */
        .hud-input {
            width: 100%;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #334155;
            transition: all 0.1s ease-in-out;
        }
        
        /* Focus State */
        .hud-input:focus {
            background-color: #ffffff;
            outline: none;
            border-color: #10b981; /* Emerald 500 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* --- BEM: Scope/Container Modifiers --- */
        .hud-scope--active {
            background-color: #ecfdf5 !important; /* Emerald 50 */
            border-color: #a7f3d0 !important; /* Emerald 200 */
        }

        /* --- BEM: Label --- */
        .hud-label {
            display: block;
            font-size: 0.65rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        /* Custom Select Arrow */
        select.hud-input {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
        }

        /* --- BEM: Stepper Control --- */
        .hud-stepper {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        .hud-stepper__btn {
            padding: 4px 10px;
            background: #f1f5f9;
            color: #64748b;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: bg 0.1s;
        }
        .hud-stepper__btn:hover { background: #e2e8f0; color: #0f172a; }
        .hud-stepper__btn:active { background: #cbd5e1; }
        
        .hud-stepper__input {
            width: 40px;
            text-align: center;
            border: none;
            background: transparent;
            font-weight: 700;
            color: #334155;
            font-size: 0.8125rem;
            outline: none;
        }

        /* --- BEM: Pills Toggle --- */
        .hud-pills {
            display: flex;
            background-color: #f1f5f9;
            padding: 2px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .hud-pills__label {
            flex: 1;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s;
            color: #64748b;
            position: relative;
        }
        
        /* Checked States */
        .hud-pills__input:checked + .hud-pills__label {
            background-color: white;
            color: #0f172a;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Modifier: Color Variants */
        .hud-pills__input:checked + .hud-pills__label--emerald { color: #059669; }
        .hud-pills__input:checked + .hud-pills__label--indigo { color: #4f46e5; }
        
        /* Focus Accessibility */
        .hud-pills__input:focus-visible + .hud-pills__label { outline: 2px solid #6366f1; z-index: 10; }

        /* --- BEM: Nav Rail --- */
        .hud-nav__item:hover .hud-nav__tooltip { opacity: 1; transform: translateX(0); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* --- BEM: Button Modifiers --- */
        @keyframes pulse-amber {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        .hud-btn--dirty {
            background-color: #d97706 !important; /* Amber 600 */
            animation: pulse-amber 2s infinite;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen overflow-hidden font-sans text-slate-600 antialiased">

    <div class="grid grid-cols-[380px_1fr_64px] h-full">
        
        <!-- LEFT SIDE: NAVIGATION -->
        <div class="bg-white h-full overflow-y-auto border-r border-slate-200 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10 relative flex flex-col">
            <div class="p-6">
                <!-- Search & Save -->
                <div class="flex gap-3 mb-6 pb-5 border-b border-slate-100 items-center">
                    <div class="relative flex-1">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
                        </div>
                        <input type="text" id="client-search" autocomplete="off"
                            class="block w-full p-2.5 pl-10 text-xs font-medium text-slate-900 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-emerald-100 focus:border-emerald-500 transition-all placeholder-slate-400" 
                            placeholder="Search clients...">
                        <div id="search-results" class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl max-h-60 overflow-y-auto"></div>
                    </div>
                    <button id="btn-save" class="text-xs font-bold text-white bg-emerald-600 hover:bg-emerald-700 px-4 py-2.5 rounded-lg shadow-sm transition-all flex items-center gap-2 whitespace-nowrap focus:ring-2 focus:ring-emerald-500 focus:outline-none" title="Ctrl + S">
                        <i class="fa-solid fa-database"></i> Save
                    </button>
                </div>

                <!-- Back Button -->
                <div class="mb-4">
                    <a href="Auto dashboard.html" class="inline-flex items-center gap-2 px-3 py-2 text-xs font-bold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all border border-slate-200 hover:border-indigo-300 shadow-sm">
                        <i class="fa-solid fa-arrow-left"></i> Back to Auto
                    </a>
                </div>

                <!-- Section Header -->
                <div class="mb-6 flex items-center gap-2 text-slate-400">
                    <i class="fa-solid fa-house text-emerald-600"></i>
                    <span class="text-xs font-bold uppercase tracking-wider">Property Insurance</span>
                </div>

                <!-- CONTROLS FORM -->
                <div id="entry-form-property" class="hud-scope" data-scope="property">
                    <form id="propertyForm" class="space-y-6">
                        <section>
                            <!-- Policy Type -->
                            <div class="mb-5">
                                <label class="block text-[11px] font-semibold text-slate-600 mb-2">Policy Type</label>
                                <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="policyType" data-key="policyType" value="Homeowners" class="hud-pills__input sr-only" checked>
                                        <div class="hud-pills__label py-2 text-center text-xs font-bold text-slate-500 rounded-md transition-all flex flex-col items-center gap-1">
                                            <i class="fa-solid fa-house-chimney text-sm"></i>
                                            Homeowners
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="policyType" data-key="policyType" value="Tenants" class="hud-pills__input sr-only">
                                        <div class="hud-pills__label py-2 text-center text-xs font-bold text-slate-500 rounded-md transition-all flex flex-col items-center gap-1">
                                            <i class="fa-solid fa-door-open text-sm"></i>
                                            Tenants
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Property Selector -->
                            <div id="prop-nav-container" class="flex items-center justify-between mb-4 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                <div class="flex-1 mr-2 relative">
                                    <select id="property-selector" class="w-full bg-transparent text-xs font-bold text-slate-700 focus:outline-none cursor-pointer appearance-none pr-6 focus:ring-2 focus:ring-emerald-500 rounded"></select>
                                    <i class="fa-solid fa-chevron-down absolute right-0 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 pointer-events-none"></i>
                                </div>
                                <div class="flex gap-1">
                                    <button type="button" onclick="App.deleteProperty()" id="btn-delete-property" class="text-rose-500 hover:text-rose-700 text-[10px] font-bold px-2 py-1.5 bg-white rounded border border-rose-200 shadow-sm hover:shadow transition-all disabled:opacity-50 focus:ring-2 focus:ring-rose-500 focus:outline-none" title="Delete Property">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                    <button type="button" onclick="App.addNewProperty()" class="text-emerald-600 hover:text-emerald-800 text-[10px] font-bold px-3 py-1.5 bg-white rounded border border-emerald-200 shadow-sm hover:shadow transition-all flex items-center gap-1 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                                        <i class="fa-solid fa-plus"></i> New
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Structure Type -->
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Structure</label>
                                <select data-key="structure" class="w-full h-9 bg-white border border-slate-200 text-slate-700 text-xs rounded-lg px-3 focus:border-emerald-500 focus:outline-none transition-all cursor-pointer">
                                    <option value="Detached">Detached</option>
                                    <option value="Semi-Detached">Semi-Detached</option>
                                    <option value="Townhouse">Townhouse</option>
                                    <option value="Condo">Condo</option>
                                    <option value="Row House">Row House</option>
                                    <option value="Mobile">Mobile Home</option>
                                </select>
                            </div>
                        </section>
                    </form>
                </div>
            </div>
            
            <div class="mt-auto p-4 border-t border-slate-200 bg-slate-50">
                <div class="text-xs font-bold text-slate-800">System Ready</div>
                <div class="text-[10px] text-slate-500 truncate">Power User Mode Active</div>
            </div>
        </div>
        
        <!-- MIDDLE: DATA FEED -->
        <div id="main-scroll-container" class="bg-slate-50 h-full overflow-y-auto relative scroll-smooth">
            <div class="sticky top-0 bg-slate-50/95 backdrop-blur z-20 px-8 py-4 border-b border-slate-200 flex flex-col justify-between shadow-sm">
                <div><h2 class="text-base font-bold text-slate-800">Applied AutoRater Data Feed</h2><p class="text-[10px] text-slate-400 font-medium uppercase tracking-wide">Extracted from DASH: 11/20/2025</p></div>
                <div class="mt-2 text-xs font-bold text-emerald-600 border-b-2 border-emerald-600 pb-1 w-max">Property Details</div>
            </div>

            <div id="tab-content-home" class="px-8 py-6 space-y-8 max-w-5xl mx-auto pb-20 fade-in">
                
                <!-- CARD 1: CLIENT DETAILS -->
                <div id="card-client" class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden hud-scope transition-colors duration-200" data-scope="customer">
                    <div class="bg-emerald-50/50 px-5 py-3 border-b border-emerald-100 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-emerald-900 uppercase tracking-widest">1. Client Details (Alt+1)</span>
                        <button type="button" id="btn-autofill-dash" onclick="App.autoFillFromDASH()" class="text-[10px] font-bold text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded shadow-sm transition-colors flex items-center gap-1">
                            <i class="fas fa-copy"></i> Auto Fill from DASH
                        </button>
                        <span data-view="quoteType" class="text-[10px] font-bold text-white bg-emerald-600 px-2 py-0.5 rounded shadow-sm">--</span>
                    </div>
                    <div class="p-5 grid grid-cols-2 gap-8">
                        <div class="space-y-5">
                            <div><label class="hud-label">Customer Name</label><input class="hud-input font-bold text-slate-800" data-key="name"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="hud-label">Date of Birth</label><input type="text" class="hud-input font-mono" data-key="dob" data-mask="date" placeholder="MM-DD-YYYY" maxlength="10"></div>
                                <div><label class="hud-label">Home Phone</label><input class="hud-input font-mono" data-key="phone" data-mask="phone" placeholder="(555) 555-5555"></div>
                            </div>
                            <div>
                                <label class="hud-label">Type of Consent</label>
                                <div class="hud-pills">
                                    <label class="flex-1"><input type="radio" name="consentRadios" value="Verbal" class="hud-pills__input sr-only"><div class="hud-pills__label hud-pills__label--emerald">Verbal</div></label>
                                    <label class="flex-1"><input type="radio" name="consentRadios" value="Written" class="hud-pills__input sr-only"><div class="hud-pills__label hud-pills__label--indigo">Written</div></label>
                                    <label class="flex-1"><input type="radio" name="consentRadios" value="None" class="hud-pills__input sr-only"><div class="hud-pills__label">None</div></label>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-5 border-l border-slate-100 pl-8">
                            <div>
                                <label class="hud-label">Address Details</label>
                                <div class="space-y-2">
                                    <input class="hud-input" data-key="address" placeholder="Street Address">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input class="hud-input" data-key="city" placeholder="City">
                                        <input class="hud-input font-mono uppercase" data-key="postal" data-mask="postal" placeholder="A1A 1A1" maxlength="7">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CARD 2: APPLICANTS -->
                <div id="card-applicants" class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden hud-scope transition-colors duration-200" data-scope="property">
                    <div class="bg-emerald-50/50 px-5 py-3 border-b border-emerald-100 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-emerald-900 uppercase tracking-widest">2. Applicants & History (Alt+2)</span>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-2 gap-8 mb-6">
                            <div id="insured-col" class="space-y-5">
                                <div>
                                    <div class="flex gap-4">
                                        <div class="flex-1">
                                            <label class="hud-label">Insured Info (DOB / Gender)</label>
                                            <div class="flex gap-2">
                                                <input type="text" class="hud-input font-mono w-full" data-key="insDob" data-mask="date" placeholder="MM-DD-YYYY" maxlength="10">
                                                <select class="hud-input w-24" data-key="insGender"><option value="Male">Male</option><option value="Female">Female</option></select>
                                            </div>
                                        </div>
                                        <div class="w-1/3"><label class="hud-label">Prop. Since</label><input type="text" class="hud-input font-mono bg-white" data-key="insuredPropertySince" data-mask="date" placeholder="MM-DD-YYYY" maxlength="10"></div>
                                    </div>
                                </div>
                                <div id="field-occupation">
                                    <label class="hud-label">Occupation</label>
                                    <div class="flex gap-2">
                                        <input class="hud-input w-full" data-key="occupation" placeholder="Occupation Title">
                                        <select class="hud-input w-40" data-key="empStatus"><option value="Full Time">Full Time</option><option value="Retired">Retired</option></select>
                                    </div>
                                </div>
                            </div>
                            <div id="co-insured-col" class="space-y-5 border-l border-slate-100 pl-8">
                                <div>
                                    <label class="hud-label">Co-Insured Info</label>
                                    <div class="flex gap-2">
                                        <input type="text" class="hud-input font-mono w-full" data-key="coDob" data-mask="date" placeholder="DOB (MM-DD-YYYY)" maxlength="10">
                                        <select class="hud-input w-28" data-key="coGender"><option value="Male">Male</option><option value="Female">Female</option></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="field-history-row" class="grid grid-cols-2 gap-4 pt-4 border-t border-slate-50 bg-slate-50/50 p-3 rounded-lg">
                            <div id="field-continuously-insured"><label class="hud-label">Continuously Insured Since</label><input type="text" class="hud-input font-mono bg-white" data-key="insuredSince" data-mask="date" placeholder="MM-DD-YYYY" maxlength="10"></div>
                            <div id="field-brokerage-since"><label class="hud-label">With Brokerage Since</label><input type="text" class="hud-input font-mono bg-white" data-key="insuredBrokerageSince" data-mask="date" placeholder="MM-DD-YYYY" maxlength="10"></div>
                        </div>
                    </div>
                </div>

                <!-- CARD 3: COVERAGE -->
                <div id="card-coverage" class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden hud-scope transition-colors duration-200" data-scope="property">
                    <div class="bg-emerald-50/50 px-5 py-3 border-b border-emerald-100 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-emerald-900 uppercase tracking-widest">3. Coverage & Mortgage (Alt+3)</span>
                    </div>
                    <div class="p-5 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 transition-all duration-300">
                            <!-- Stepper for Mortgages -->
                            <div id="field-mortgage">
                                <label class="hud-label"># of Mortgages</label>
                                <div class="hud-stepper">
                                    <button type="button" class="hud-stepper__btn" onclick="App.stepValue(this, -1)">-</button>
                                    <input type="text" class="hud-stepper__input" data-key="mortgageCount" value="0" readonly>
                                    <button type="button" class="hud-stepper__btn" onclick="App.stepValue(this, 1)">+</button>
                                </div>
                            </div>
                            <div id="field-first-time">
                                <label class="hud-label">First Time Buyer</label>
                                <div class="hud-pills">
                                    <label class="flex-1"><input type="radio" name="firstTimeBuyer" data-key="firstTimeBuyer" value="Yes" class="hud-pills__input sr-only"><div class="hud-pills__label hud-pills__label--emerald">Yes</div></label>
                                    <label class="flex-1"><input type="radio" name="firstTimeBuyer" data-key="firstTimeBuyer" value="No" class="hud-pills__input sr-only"><div class="hud-pills__label">No</div></label>
                                </div>
                            </div>
                            <div>
                                <label class="hud-label">Smoke Free</label>
                                <div class="hud-pills">
                                    <label class="flex-1"><input type="radio" name="smokeFree" data-key="smokeFree" value="Yes" class="hud-pills__input sr-only"><div class="hud-pills__label hud-pills__label--emerald">Yes</div></label>
                                    <label class="flex-1"><input type="radio" name="smokeFree" data-key="smokeFree" value="No" class="hud-pills__input sr-only"><div class="hud-pills__label">No</div></label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="hud-label">Coverage Type</label>
                            <select class="hud-input font-medium" data-key="coverageType">
                                <option value="All Risks / All Risks">All Risks / All Risks (Comprehensive)</option>
                                <option value="All Risks / Named Perils">All Risks / Named Perils (Broad)</option>
                                <option value="Named Perils / Named Perils">Named Perils / Named Perils (Standard)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-6 pt-2 border-t border-slate-50">
                            <div><label class="hud-label text-emerald-600">Deductible</label><select class="hud-input font-bold text-emerald-700" data-key="deductible"><option value="1000">$1,000</option><option value="1500">$1,500</option><option value="2500">$2,500</option><option value="5000">$5,000</option></select></div>
                            <div><label class="hud-label text-emerald-600">Liability</label><select class="hud-input font-bold text-emerald-700" data-key="liability"><option value="1M">$1,000,000</option><option value="2M">$2,000,000</option></select></div>
                            <label id="field-gbrc" class="flex items-center justify-between p-2 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors"><span class="text-xs font-bold text-slate-500 uppercase tracking-wide">GBRC Limit</span><input type="checkbox" data-key="gbrc" class="accent-emerald-600 w-5 h-5 rounded focus:ring-2 focus:ring-emerald-500"></label>
                            <label id="field-single-limit" class="flex items-center justify-between p-2 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors"><span class="text-xs font-bold text-slate-500 uppercase tracking-wide">Single Limit</span><input type="checkbox" data-key="singleLimit" class="accent-emerald-600 w-5 h-5 rounded focus:ring-2 focus:ring-emerald-500"></label>
                        </div>
                    </div>
                </div>

                <!-- CARD 4: PROPERTY DETAILS -->
                <div id="card-property-systems" class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden hud-scope transition-colors duration-200" data-scope="property">
                    <div class="bg-emerald-50/50 px-5 py-3 border-b border-emerald-100 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-emerald-900 uppercase tracking-widest">4. Property Details (Alt+4)</span>
                    </div>
                    <div class="p-5 space-y-8">
                        <div id="section-building">
                            <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-wider border-b border-slate-100 pb-2 mb-4">Building & Occupancy</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div id="field-year-built" class="col-span-1"><label class="hud-label">Year Built</label><input class="hud-input font-mono text-center" data-key="yearBuilt" maxlength="4" placeholder="YYYY"></div>
                                <div id="field-occupied-since" class="col-span-1"><label class="hud-label">Occupied Since</label><input class="hud-input font-mono text-center" data-key="occupiedSince" maxlength="7" placeholder="MM-YYYY" oninput="App.formatMonthYear(this)"></div>
                                <div id="field-living-area" class="col-span-1 md:col-span-2"><label class="hud-label">Total Living Area (sq ft)</label><input class="hud-input font-mono text-center font-bold text-slate-700 bg-slate-50 border-slate-200" data-key="livingArea" placeholder="SF"></div>
                                
                                <!-- Steppers for Counts -->
                                <div id="field-stories"><label class="hud-label">Stories</label>
                                    <div class="hud-stepper"><button type="button" class="hud-stepper__btn" onclick="App.stepValue(this, -1)">-</button><input class="hud-stepper__input" data-key="storeys" value="2" readonly><button type="button" class="hud-stepper__btn" onclick="App.stepValue(this, 1)">+</button></div>
                                </div>
                                <div id="field-families"><label class="hud-label">Families</label>
                                    <div class="hud-stepper"><button type="button" class="hud-stepper__btn" onclick="App.stepValue(this, -1)">-</button><input class="hud-stepper__input" data-key="families" value="1" readonly><button type="button" class="hud-stepper__btn" onclick="App.stepValue(this, 1)">+</button></div>
                                </div>
                                <div id="field-units"><label class="hud-label">Units</label>
                                    <div class="hud-stepper"><button type="button" class="hud-stepper__btn" onclick="App.stepValue(this, -1)">-</button><input class="hud-stepper__input" data-key="units" value="1" readonly><button type="button" class="hud-stepper__btn" onclick="App.stepValue(this, 1)">+</button></div>
                                </div>

                                <div id="field-owner-occ">
                                    <label class="hud-label">Owner Occ</label>
                                    <div class="flex justify-center pt-1.5 gap-3">
                                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="ownerOcc" data-key="ownerOcc" value="Yes" class="accent-emerald-600 w-3 h-3 focus:ring-2 focus:ring-emerald-500"><span class="text-[10px] font-bold text-slate-600">Yes</span></label>
                                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="ownerOcc" data-key="ownerOcc" value="No" class="accent-emerald-600 w-3 h-3 focus:ring-2 focus:ring-emerald-500"><span class="text-[10px] font-bold text-slate-600">No</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="section-interior">
                            <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-wider border-b border-slate-100 pb-2 mb-4">Interior & Basement</h4>
                            <div class="grid grid-cols-2 gap-8 items-start" id="interior-grid">
                                <div id="field-baths" class="col-span-1">
                                    <label class="hud-label">Bathrooms</label>
                                    <div class="flex rounded-md shadow-sm">
                                        <div class="relative flex-1"><input type="text" class="hud-input rounded-r-none border-r-0 text-center" data-key="fullBaths" placeholder="0"><span class="absolute top-0 right-2 text-[9px] text-slate-400 font-bold leading-7 pointer-events-none">Full</span></div>
                                        <div class="relative flex-1"><input type="text" class="hud-input rounded-l-none text-center border-l" data-key="halfBaths" placeholder="0"><span class="absolute top-0 right-2 text-[9px] text-slate-400 font-bold leading-7 pointer-events-none">Half</span></div>
                                    </div>
                                </div>
                                <div id="field-basement-group" class="space-y-3 col-span-1">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div id="field-bsmt-sqft"><label class="hud-label">Basement Sq Ft</label><input class="hud-input text-center font-mono" data-key="bsmtArea" placeholder="SF"></div>
                                        <div class="relative" id="field-bsmt-fin"><label class="hud-label">Finished %</label><input class="hud-input text-center font-mono" data-key="bsmtFin" placeholder="0"><span class="absolute top-6 right-3 text-sm text-slate-400 font-bold pointer-events-none">%</span></div>
                                    </div>
                                    <div class="flex justify-between items-center bg-slate-50 px-3 py-2 rounded border border-slate-100">
                                        <div class="flex flex-col items-center"><span class="text-[9px] font-bold text-slate-400 uppercase mb-1">Sep. Entrance?</span><div class="flex gap-2"><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="sepEntrance" data-key="sepEntrance" value="Yes" class="accent-indigo-600 w-3 h-3"><span class="text-[10px] font-medium text-slate-600">Y</span></label><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="sepEntrance" data-key="sepEntrance" value="No" class="accent-slate-400 w-3 h-3"><span class="text-[10px] font-medium text-slate-600">N</span></label></div></div>
                                        <div class="w-px h-8 bg-slate-200"></div>
                                        <div class="flex flex-col items-center"><span class="text-[9px] font-bold text-slate-400 uppercase mb-1">Apt Rented?</span><div class="flex gap-2"><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="bsmtRented" data-key="bsmtRented" value="Yes" class="accent-indigo-600 w-3 h-3"><span class="text-[10px] font-medium text-slate-600">Y</span></label><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="bsmtRented" data-key="bsmtRented" value="No" class="accent-slate-400 w-3 h-3"><span class="text-[10px] font-medium text-slate-600">N</span></label></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-end border-b border-slate-100 pb-2 mb-4"><h4 class="text-[10px] font-black text-slate-300 uppercase tracking-wider">System Updates (Year)</h4><label id="btn-standard-updates" class="flex items-center gap-2 cursor-pointer hidden"><input type="checkbox" class="accent-emerald-600 w-3 h-3 rounded"><span class="text-[10px] font-bold text-emerald-600 uppercase tracking-wide">Standard</span></label></div>
                            <div class="grid grid-cols-5 gap-3 mb-4">
                                <div><label class="hud-label">Heating</label><input class="hud-input font-mono text-center" data-key="heatYear" placeholder="YYYY" maxlength="4"></div>
                                <div><label class="hud-label">Electric</label><input class="hud-input font-mono text-center" data-key="elecYear" placeholder="YYYY" maxlength="4"></div>
                                <div><label class="hud-label">Plumbing</label><input class="hud-input font-mono text-center" data-key="plumbYear" placeholder="YYYY" maxlength="4"></div>
                                <div><label class="hud-label">Roofing</label><input class="hud-input font-mono text-center" data-key="roofYear" placeholder="YYYY" maxlength="4"></div>
                                <div><label class="hud-label">HWT</label><input class="hud-input font-mono text-center" data-key="tankYear" placeholder="YYYY" maxlength="4"></div>
                            </div>
                            <div id="field-tank-type" class="flex items-center justify-end gap-3"><span class="text-[10px] font-bold text-slate-400 uppercase">Water Heater:</span><div class="flex gap-3 bg-slate-50 px-3 py-1.5 rounded border border-slate-100"><label class="flex items-center gap-1.5 cursor-pointer"><input type="radio" name="tankType" data-key="tankType" value="Tank" class="accent-indigo-600 w-3 h-3"><span class="text-xs font-bold text-slate-600">Tank</span></label><label class="flex items-center gap-1.5 cursor-pointer"><input type="radio" name="tankType" data-key="tankType" value="Tankless" class="accent-indigo-600 w-3 h-3"><span class="text-xs font-bold text-slate-600">Tankless</span></label></div></div>
                        </div>

                        <!-- Safety (Condensed for flow) -->
                        <div>
                            <h4 class="text-[10px] font-black text-slate-300 uppercase tracking-wider border-b border-slate-100 pb-2 mb-4">Safety & Alarms</h4>
                            <div class="grid grid-cols-2 gap-x-8 gap-y-3">
                                <div class="flex justify-between items-center border-b border-dashed border-slate-100 pb-2"><span class="text-xs font-bold text-slate-600">Monitored Burglar</span><div class="flex gap-2"><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="burglar" data-key="burglar" value="Yes" class="accent-emerald-600 w-3 h-3"><span class="text-[10px] text-slate-500">Yes</span></label><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="burglar" data-key="burglar" value="No" class="accent-slate-400 w-3 h-3"><span class="text-[10px] text-slate-500">No</span></label></div></div>
                                <div class="flex justify-between items-center border-b border-dashed border-slate-100 pb-2"><span class="text-xs font-bold text-slate-600">Monitored Fire</span><div class="flex gap-2"><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="fire" data-key="fire" value="Yes" class="accent-emerald-600 w-3 h-3"><span class="text-[10px] text-slate-500">Yes</span></label><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="fire" data-key="fire" value="No" class="accent-slate-400 w-3 h-3"><span class="text-[10px] text-slate-500">No</span></label></div></div>
                                <div class="flex justify-between items-center border-b border-dashed border-slate-100 pb-2"><span class="text-xs font-bold text-slate-600">Sprinkler System</span><div class="flex gap-2"><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="sprinkler" data-key="sprinkler" value="Yes" class="accent-emerald-600 w-3 h-3"><span class="text-[10px] text-slate-500">Yes</span></label><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="sprinkler" data-key="sprinkler" value="No" class="accent-slate-400 w-3 h-3"><span class="text-[10px] text-slate-500">No</span></label></div></div>
                                <div id="field-sump-pump" class="flex justify-between items-center border-b border-dashed border-slate-100 pb-2"><span class="text-xs font-bold text-slate-600">Sump Pit</span><div class="flex gap-2"><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="sumpPump" data-key="sumpPump" value="Yes" class="accent-emerald-600 w-3 h-3"><span class="text-[10px] text-slate-500">Yes</span></label><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="sumpPump" data-key="sumpPump" value="No" class="accent-slate-400 w-3 h-3"><span class="text-[10px] text-slate-500">No</span></label></div></div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- CARD 5: ADDITIONAL -->
                <div id="card-additional" class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden hud-scope transition-colors duration-200" data-scope="property">
                    <div class="bg-emerald-50/50 px-5 py-3 border-b border-emerald-100 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-emerald-900 uppercase tracking-widest">5. Additional Details (Alt+5)</span>
                    </div>
                    <div class="p-5">
                        <label class="hud-label">Notes & Remarks</label>
                        <textarea class="hud-input w-full h-32 resize-none" data-key="additionalNotes" placeholder="Enter notes..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE: NAV RAIL -->
        <div class="bg-white border-l border-slate-200 h-full flex flex-col items-center py-6 gap-6 z-20 shadow-[-4px_0_24px_rgba(0,0,0,0.02)]">
            <button id="btn-nav-client" class="hud-nav__item group relative flex items-center justify-center w-8 h-8 rounded-full hover:bg-emerald-50 text-slate-400 hover:text-emerald-600 transition-all focus:outline-none"><i class="fa-solid fa-user text-xs"></i><span class="hud-nav__tooltip absolute right-12 bg-slate-800 text-white text-[10px] font-bold px-2 py-1.5 rounded opacity-0 transition-all whitespace-nowrap pointer-events-none shadow-lg translate-x-2">Client Details (Alt+1)<div class="absolute right-[-4px] top-1/2 -translate-y-1/2 w-2 h-2 bg-slate-800 rotate-45"></div></span></button>
            <button id="btn-nav-applicants" class="hud-nav__item group relative flex items-center justify-center w-8 h-8 rounded-full hover:bg-emerald-50 text-slate-400 hover:text-emerald-600 transition-all focus:outline-none"><i class="fa-solid fa-users text-xs"></i><span class="hud-nav__tooltip absolute right-12 bg-slate-800 text-white text-[10px] font-bold px-2 py-1.5 rounded opacity-0 transition-all whitespace-nowrap pointer-events-none shadow-lg translate-x-2">Applicants (Alt+2)<div class="absolute right-[-4px] top-1/2 -translate-y-1/2 w-2 h-2 bg-slate-800 rotate-45"></div></span></button>
            <button id="btn-nav-coverage" class="hud-nav__item group relative flex items-center justify-center w-8 h-8 rounded-full hover:bg-emerald-50 text-slate-400 hover:text-emerald-600 transition-all focus:outline-none"><i class="fa-solid fa-shield-halved text-xs"></i><span class="hud-nav__tooltip absolute right-12 bg-slate-800 text-white text-[10px] font-bold px-2 py-1.5 rounded opacity-0 transition-all whitespace-nowrap pointer-events-none shadow-lg translate-x-2">Coverage (Alt+3)<div class="absolute right-[-4px] top-1/2 -translate-y-1/2 w-2 h-2 bg-slate-800 rotate-45"></div></span></button>
            <button id="btn-nav-property" class="hud-nav__item group relative flex items-center justify-center w-8 h-8 rounded-full hover:bg-emerald-50 text-slate-400 hover:text-emerald-600 transition-all focus:outline-none"><i class="fa-solid fa-house text-xs"></i><span class="hud-nav__tooltip absolute right-12 bg-slate-800 text-white text-[10px] font-bold px-2 py-1.5 rounded opacity-0 transition-all whitespace-nowrap pointer-events-none shadow-lg translate-x-2">Property (Alt+4)<div class="absolute right-[-4px] top-1/2 -translate-y-1/2 w-2 h-2 bg-slate-800 rotate-45"></div></span></button>
            <button id="btn-nav-additional" class="hud-nav__item group relative flex items-center justify-center w-8 h-8 rounded-full hover:bg-emerald-50 text-slate-400 hover:text-emerald-600 transition-all focus:outline-none"><i class="fa-solid fa-clipboard-list text-xs"></i><span class="hud-nav__tooltip absolute right-12 bg-slate-800 text-white text-[10px] font-bold px-2 py-1.5 rounded opacity-0 transition-all whitespace-nowrap pointer-events-none shadow-lg translate-x-2">Notes (Alt+5)<div class="absolute right-[-4px] top-1/2 -translate-y-1/2 w-2 h-2 bg-slate-800 rotate-45"></div></span></button>
        </div>
    </div>

    <script>
        const CONFIG = {
            TENANT_HIDDEN_FIELDS: ['co-insured-col', 'field-mortgage', 'field-first-time', 'field-gbrc', 'field-single-limit', 'field-occupation', 'section-building', 'field-basement-group', 'field-tank-type', 'field-sump-pump', 'field-continuously-insured', 'field-brokerage-since']
        };

        const DataFactory = {
            createDefaultCustomer: () => ({ name: '', address: '', city: '', postal: '', phone: '', dob: '', consent: 'Verbal', quoteType: 'New Business' }),
            createDefaultProperty: (type = 'Homeowners') => ({
                policyType: type, structure: type === 'Homeowners' ? 'Detached' : '',
                deductible: '2500', liability: '2M', mortgageCount: '0', smokeFree: 'Yes', firstTimeBuyer: 'No', coverageType: 'All Risks / All Risks', gbrc: 'Yes', singleLimit: 'No',
                yearBuilt: '', occupiedSince: '', storeys: '2', units: '1', families: '1', ownerOcc: 'Yes', livingArea: '',
                fullBaths: '1', halfBaths: '0', bsmtFinBool: 'No', bsmtRented: 'No', sepEntrance: 'No', bsmtFin: '', bsmtArea: '',
                burglar: 'No', fire: 'No', sprinkler: 'No', sumpPump: 'No', fireExt: '0', smokeDet: '0',
                elecYear: '', plumbYear: '', roofYear: '', heatYear: '', tankYear: '', tankType: 'Tank',
                insDob: '', insGender: 'Male', occupation: '', empStatus: 'Full Time', coDob: '', coGender: '',
                insuredSince: '', insuredPropertySince: '', insuredBrokerageSince: '', additionalNotes: ''
            })
        };

        const Binder = {
            syncFromDom: (scope, stateObj, activeElement) => {
                const inputs = document.querySelectorAll(`.hud-scope[data-scope="${scope}"] [data-key]`);
                inputs.forEach(el => {
                    if (el === activeElement) {
                        const key = el.dataset.key;
                        if (el.type === 'checkbox') stateObj[key] = el.checked ? 'Yes' : 'No';
                        else if (el.type === 'radio') { if (el.checked) stateObj[key] = el.value; }
                        else stateObj[key] = el.value;
                    }
                });
            },
            loadToDom: (scope, stateObj, activeElement) => {
                if (!stateObj) return; 
                document.querySelectorAll(`.hud-scope[data-scope="${scope}"] [data-key]`).forEach(el => {
                    if (el === activeElement || (el.type === 'radio' && el === activeElement)) return;
                    const key = el.dataset.key;
                    let val = stateObj[key] !== undefined ? stateObj[key] : '';
                    if (el.type === 'checkbox') el.checked = (val === 'Yes' || val === true);
                    else if (el.type === 'radio') { if (key === 'policyType') return; el.checked = (el.value === val); }
                    else el.value = val;
                });
            },
            renderToDom: (scope, stateObj) => {
                if (!stateObj) return; 
                document.querySelectorAll(`.hud-scope[data-scope="${scope}"] [data-view]`).forEach(el => {
                    el.innerText = stateObj[el.dataset.view] !== undefined ? stateObj[el.dataset.view] : '‚Äî';
                });
            }
        };

        const App = {
            db: [{ id: 'c1', ...DataFactory.createDefaultCustomer(), properties: [{ ...DataFactory.createDefaultProperty(), id: 1 }] }],
            blankTenant: { customer: { ...DataFactory.createDefaultCustomer(), quoteType: 'Tenant Quote' }, property: DataFactory.createDefaultProperty('Tenants') },
            properties: [], customer: {}, currPropIdx: 0, viewMode: 'Homeowners', isDirty: false,

            // Select a lead and load property data for that lead
            selectLead: async function(name, phone, email) {
                console.log('üë§ Selecting lead (property):', {name, phone, email});
                // Update search box
                const searchInput = document.getElementById('client-search');
                if (searchInput) searchInput.value = name;
                // Store original lead info for search restore
                this.originalLead = { name, phone, email };
                localStorage.setItem('autoDashboardOriginalLead', JSON.stringify(this.originalLead));

                // Try to load saved property data for this lead from database
                if (email) {
                    try {
                        console.log('üìÇ Fetching saved property data for:', email);
                        const response = await fetch(`${window.location.origin}/api/get-property-data/${encodeURIComponent(email)}`);
                        const result = await response.json();
                        if (result.success && result.data) {
                            console.log('‚úÖ Loaded saved property data:', result.data);
                            
                            // NEW: Check if customer column contains the combined dual-mode data (JSONB workaround)
                            let savedData = result.data;
                            if (result.data.customer && typeof result.data.customer === 'object' && 
                                (result.data.customer.viewMode || result.data.customer.homeowners || result.data.customer.tenants)) {
                                console.log('üì¶ Found combined data in customer column (JSONB workaround format)');
                                savedData = result.data.customer;
                            }
                            
                            console.log('üìã Saved viewMode:', savedData.viewMode);
                            
                            // NEW: Load BOTH Homeowners and Tenants data if available
                            if (savedData.homeowners) {
                                console.log('üè† Loading Homeowners data from saved data...');
                                if (savedData.homeowners.customer) {
                                    this.customer = { ...savedData.homeowners.customer };
                                }
                                if (savedData.homeowners.properties) {
                                    this.properties = JSON.parse(JSON.stringify(savedData.homeowners.properties));
                                }
                                console.log('‚úÖ Loaded Homeowners customer:', this.customer);
                                console.log('‚úÖ Loaded Homeowners properties:', this.properties);
                            } else if (result.data.customer && typeof result.data.customer !== 'object' && result.data.properties) {
                                // Fallback to old format for backwards compatibility
                                console.log('üìÑ Loading from old format (backwards compatibility)...');
                                this.customer = { ...result.data.customer };
                                this.properties = JSON.parse(JSON.stringify(result.data.properties));
                            }
                            
                            // NEW: Load Tenants data if available
                            if (savedData.tenants) {
                                console.log('üè¢ Loading Tenants data from saved data...');
                                if (savedData.tenants.customer) {
                                    // Merge with default to ensure all fields exist
                                    const defaultTenantCustomer = { ...DataFactory.createDefaultCustomer(), quoteType: 'Tenant Quote' };
                                    this.blankTenant.customer = { ...defaultTenantCustomer, ...savedData.tenants.customer };
                                }
                                if (savedData.tenants.properties && savedData.tenants.properties.length > 0) {
                                    // Merge with default to ensure all fields exist
                                    const defaultTenantProperty = DataFactory.createDefaultProperty('Tenants');
                                    this.blankTenant.property = { ...defaultTenantProperty, ...savedData.tenants.properties[0] };
                                }
                                console.log('‚úÖ Loaded Tenants customer:', this.blankTenant.customer);
                                console.log('‚úÖ Loaded Tenants property:', this.blankTenant.property);
                            } else {
                                console.log('‚ö†Ô∏è No Tenants data found in saved data, using defaults');
                                this.blankTenant.customer = { ...DataFactory.createDefaultCustomer(), quoteType: 'Tenant Quote' };
                                this.blankTenant.property = DataFactory.createDefaultProperty('Tenants');
                            }
                            
                            // Restore viewMode if it was saved
                            if (savedData.viewMode) {
                                this.viewMode = savedData.viewMode;
                                console.log('‚úÖ Set viewMode to:', this.viewMode);
                            } else {
                                // Default to Homeowners if no viewMode saved
                                this.viewMode = 'Homeowners';
                                console.log('‚ö†Ô∏è No viewMode found, defaulting to Homeowners');
                            }
                            
                            this.currPropIdx = 0;
                            this.renderSelectors();
                            
                            // Important: Switch mode and refresh UI to display loaded data
                            if (this.viewMode === 'Tenants') {
                                console.log('üîÑ Switching to Tenants mode and refreshing UI...');
                                this.switchPolicyType('Tenants');
                                // Also set the radio button
                                const tenantRadio = document.querySelector('input[name="policyType"][value="Tenants"]');
                                if (tenantRadio) {
                                    tenantRadio.checked = true;
                                    console.log('‚úÖ Set Tenants radio button');
                                }
                                // CRITICAL: Refresh UI to populate form fields with loaded Tenants data
                                console.log('üîÑ Refreshing UI to display loaded Tenants data in form...');
                                this.refreshUI();
                            } else {
                                console.log('üîÑ Loading in Homeowners mode and refreshing UI');
                                this.refreshUI();
                            }
                            
                            // Restore consent field for the current mode
                            const currentCustomer = this.viewMode === 'Tenants' ? this.blankTenant.customer : this.customer;
                            if (currentCustomer && currentCustomer.consent) {
                                console.log(`üîç Restoring consent value: ${currentCustomer.consent}`);
                                const consentRadio = document.querySelector(`input[name="consentRadios"][value="${currentCustomer.consent}"]`);
                                if (consentRadio) {
                                    consentRadio.checked = true;
                                    console.log(`‚úÖ Set consent radio to: ${currentCustomer.consent}`);
                                } else {
                                    console.warn(`‚ö†Ô∏è Could not find consent radio with value: ${currentCustomer.consent}`);
                                }
                            } else {
                                console.log(`‚ö†Ô∏è No consent value found for ${this.viewMode} mode`);
                            }
                        } else {
                            console.log('‚ÑπÔ∏è No saved property data found for this lead, resetting to blank');
                            this.customer = DataFactory.createDefaultCustomer();
                            this.properties = [DataFactory.createDefaultProperty()];
                            this.blankTenant.customer = { ...DataFactory.createDefaultCustomer(), quoteType: 'Tenant Quote' };
                            this.blankTenant.property = DataFactory.createDefaultProperty('Tenants');
                            this.viewMode = 'Homeowners'; // Reset to default
                            this.currPropIdx = 0;
                            this.renderSelectors();
                            this.refreshUI();
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Could not load saved property data:', error);
                        this.customer = DataFactory.createDefaultCustomer();
                        this.properties = [DataFactory.createDefaultProperty()];
                        this.blankTenant.customer = { ...DataFactory.createDefaultCustomer(), quoteType: 'Tenant Quote' };
                        this.blankTenant.property = DataFactory.createDefaultProperty('Tenants');
                        this.viewMode = 'Homeowners'; // Reset to default
                        this.currPropIdx = 0;
                        this.renderSelectors();
                        this.refreshUI();
                    }
                }
                // Hide dropdown
                document.getElementById('search-results').classList.add('hidden');
                console.log('‚úÖ Lead selected and property data loaded successfully!');
            },

            init: function() {
                // Restore lead name in search input from localStorage
                const savedOriginalLead = localStorage.getItem('autoDashboardOriginalLead');
                if (savedOriginalLead) {
                    try {
                        const originalLead = JSON.parse(savedOriginalLead);
                        if (originalLead.name) {
                            document.getElementById('client-search').value = originalLead.name;
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Failed to restore original lead:', e);
                    }
                }
                
                // Add search input event listeners
                const searchInput = document.getElementById('client-search');
                if (searchInput) {
                    searchInput.addEventListener('blur', () => {
                        // When search is cleared, restore original lead name
                        if (!searchInput.value.trim()) {
                            const savedOriginalLead = localStorage.getItem('autoDashboardOriginalLead');
                            if (savedOriginalLead) {
                                try {
                                    const originalLead = JSON.parse(savedOriginalLead);
                                    if (originalLead.name) {
                                        searchInput.value = originalLead.name;
                                    }
                                } catch (e) {}
                            }
                        }
                    });
                    searchInput.addEventListener('input', (e) => {
                        App.handleSearch(e.target.value);
                    });
                }
                
                this.loadCustomer('c1');
                document.body.addEventListener('input', (e) => {
                    if (e.target.matches('[data-key]')) {
                        this.handleInput(e.target);
                    }
                });
                
                // Update auto-fill button label to show selected driver
                this.updateAutoFillButtonLabel();
                
                // Attach additional event listeners
                this.attachEventListeners();
            },

            updateAutoFillButtonLabel: function() {
                const btn = document.getElementById('btn-autofill-dash');
                if (!btn) return;
                
                const driversStr = localStorage.getItem('autoDashboardDrivers');
                const currDrvIdxStr = localStorage.getItem('autoDashboardCurrDrvIdx');
                
                if (driversStr) {
                    try {
                        const drivers = JSON.parse(driversStr);
                        const currDrvIdx = parseInt(currDrvIdxStr || '0');
                        const selectedDriver = drivers[currDrvIdx];
                        
                        if (selectedDriver) {
                            const driverNum = selectedDriver.id || (currDrvIdx + 1);
                            btn.innerHTML = `<i class="fas fa-copy"></i> Fill from Driver ${driverNum}`;
                            console.log(`‚úÖ Auto-fill button shows: Driver ${driverNum}`);
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Failed to update auto-fill button:', e);
                    }
                }
            },

            attachEventListeners: function() {
                // Apply masks
                document.body.addEventListener('input', (e) => {
                    if (e.target.dataset.mask) this.applyMask(e.target);
                });

                // Save button
                const saveBtn = document.getElementById('btn-save');
                if (saveBtn) saveBtn.addEventListener('click', () => App.saveToDatabase());

                // Policy type radios
                document.querySelectorAll('input[name="policyType"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        App.switchPolicyType(this.value);
                    });
                });

                // Property selector
                const propSelector = document.getElementById('property-selector');
                if (propSelector) propSelector.addEventListener('change', function() {
                    App.switchProperty(this.value);
                });

                // Consent radios
                document.querySelectorAll('input[name="consentRadios"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        App.setConsent(this.value);
                    });
                });

                // Delete property button
                const delBtn = document.getElementById('btn-delete-property');
                if (delBtn) delBtn.addEventListener('click', () => App.deleteProperty());

                // Add property button
                const addBtn = document.getElementById('btn-add-property');
                if (addBtn) addBtn.addEventListener('click', () => App.addNewProperty());

                // Stepper buttons
                document.querySelectorAll('.hud-stepper__btn[data-step]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        App.stepValue(this, parseInt(this.getAttribute('data-step')));
                    });
                });

                // Standard updates checkbox
                const stdUpdates = document.querySelector('#btn-standard-updates input[type="checkbox"]');
                if (stdUpdates) stdUpdates.addEventListener('change', function() {
                    App.toggleStandardUpdates(this);
                });
                
                // Focus Mode Logic
                document.addEventListener('focusin', (e) => {
                    if (e.target.matches('.hud-input') || e.target.matches('.hud-pills__input')) {
                        const row = e.target.closest('.hud-scope');
                        if (row) {
                            document.querySelectorAll('.hud-scope').forEach(r => r.classList.remove('hud-scope--active'));
                            row.classList.add('hud-scope--active');
                        }
                    }
                });

                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); this.saveToDatabase(); }
                    if (e.altKey && e.key === '1') { e.preventDefault(); this.scrollToSection('card-client'); }
                    if (e.altKey && e.key === '2') { e.preventDefault(); this.scrollToSection('card-applicants'); }
                    if (e.altKey && e.key === '3') { e.preventDefault(); this.scrollToSection('card-coverage'); }
                    if (e.altKey && e.key === '4') { e.preventDefault(); this.scrollToSection('card-property-systems'); }
                    if (e.altKey && e.key === '5') { e.preventDefault(); this.scrollToSection('card-additional'); }
                });
            },

            // --- MASKS & FORMATTING ---
            applyMask: function(el) {
                let v = el.value.replace(/\D/g, ''); // Strip non-digits
                
                if (el.dataset.mask === 'date') {
                    if (v.length > 8) v = v.slice(0, 8);
                    if (v.length >= 5) el.value = `${v.slice(0,2)}-${v.slice(2,4)}-${v.slice(4)}`;
                    else if (v.length >= 3) el.value = `${v.slice(0,2)}-${v.slice(2)}`;
                    else el.value = v;
                } else if (el.dataset.mask === 'phone') {
                    if (v.length > 10) v = v.slice(0, 10);
                    if (v.length >= 7) el.value = `(${v.slice(0,3)}) ${v.slice(3,6)}-${v.slice(6)}`;
                    else if (v.length >= 4) el.value = `(${v.slice(0,3)}) ${v.slice(3)}`;
                    else if (v.length > 0) el.value = `(${v}`;
                    else el.value = v;
                } else if (el.dataset.mask === 'postal') {
                     // Postals are alphanumeric, need separate logic
                     let raw = el.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().slice(0, 6);
                     if(raw.length > 3) el.value = `${raw.slice(0,3)} ${raw.slice(3)}`;
                     else el.value = raw;
                }
            },
            
            formatMonthYear: function(el) {
                let v = el.value.replace(/\D/g, '').slice(0, 6);
                if (v.length >= 3) el.value = `${v.slice(0,2)}-${v.slice(2)}`;
                else el.value = v;
            },

            // --- STEPPERS ---
            stepValue: function(btn, step) {
                const container = btn.parentElement;
                const input = container.querySelector('input');
                let val = parseInt(input.value) || 0;
                val += step;
                if (val < 0) val = 0;
                input.value = val;
                // Manually trigger input event so data saves
                input.dispatchEvent(new Event('input', { bubbles: true }));
            },

            setDirty: function(isDirty) {
                this.isDirty = isDirty;
                const btn = document.getElementById('btn-save');
                if (isDirty) {
                    btn.classList.add('hud-btn--dirty');
                    btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Unsaved';
                } else {
                    btn.classList.remove('hud-btn--dirty');
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Save';
                }
            },

            scrollToSection: function(id) {
                const el = document.getElementById(id);
                const container = document.getElementById('main-scroll-container');
                if(el && container) {
                    const topPos = el.offsetTop - 120;
                    container.scrollTo({ top: topPos, behavior: 'smooth' });
                    // Visual focus bump
                    el.classList.add('ring-2', 'ring-emerald-400');
                    setTimeout(() => el.classList.remove('ring-2', 'ring-emerald-400'), 1000);
                }
            },

            handleInput: function(target) {
                if (target.name === 'policyType') return;
                const container = target.closest('.hud-scope');
                if(!container) return;
                const scope = container.dataset.scope;
                
                let targetCustomer = (this.viewMode === 'Tenants') ? this.blankTenant.customer : this.customer;
                let targetProperty = (this.viewMode === 'Tenants') ? this.blankTenant.property : this.properties[this.currPropIdx];

                if (scope === 'customer') {
                    Binder.syncFromDom('customer', targetCustomer, target);
                    Binder.loadToDom('customer', targetCustomer, target);
                    if(target.name === 'consentRadios') this.syncConsentRadios(); 
                } else if (scope === 'property' && targetProperty) {
                    Binder.syncFromDom('property', targetProperty, target);
                    Binder.loadToDom('property', targetProperty, target);
                    if (this.updateHeader) this.updateHeader();
                }
            },

            loadCustomer: function(id) {
                const c = this.db.find(x => x.id === id);
                if(!c) return;
                this.customer = { ...c }; delete this.customer.properties;
                this.properties = JSON.parse(JSON.stringify(c.properties));
                this.currPropIdx = 0;
                this.viewMode = 'Homeowners';
                this.renderSelectors();
                this.refreshUI();
                document.getElementById('search-results').classList.add('hidden');
                
                // Show the lead name being processed (from auto dashboard), not the customer name
                const savedOriginalLead = localStorage.getItem('autoDashboardOriginalLead');
                let searchName = 'Customer';
                if (savedOriginalLead) {
                    try {
                        const originalLead = JSON.parse(savedOriginalLead);
                        if (originalLead.name) {
                            searchName = originalLead.name;
                        }
                    } catch (e) {}
                }
                document.getElementById('client-search').value = searchName;
            },

            renderSelectors: function() {
                const pSel = document.getElementById('property-selector'); 
                if(pSel) {
                    pSel.innerHTML = '';
                    this.properties.forEach((p, i) => {
                        const label = (i === 0) ? "Property 1 - Primary" : `Secondary ${i}`;
                        pSel.add(new Option(label, i, i===this.currPropIdx, i===this.currPropIdx));
                    });
                }
            },
            refreshUI: function() {
                // Load customer data to DOM
                Binder.loadToDom('customer', this.customer);
                // Load current property data to DOM
                const currProp = this.properties[this.currPropIdx];
                if (currProp) {
                    Binder.loadToDom('property', currProp);
                }
                if (this.updateHeader) this.updateHeader();
            },
            switchProperty: function(idx) { this.currPropIdx = parseInt(idx); this.refreshUI(); },
            switchPolicyType: function(val) {
                this.viewMode = val;
                const isTenant = (val === 'Tenants');
                const navRow = document.getElementById('prop-nav-container');
                if(navRow) navRow.classList.toggle('hidden', isTenant);
                CONFIG.TENANT_HIDDEN_FIELDS.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) isTenant ? el.classList.add('hidden') : el.classList.remove('hidden');
                });
                const insuredCol = document.getElementById('insured-col');
                if(insuredCol) isTenant ? insuredCol.classList.replace('col-span-1', 'col-span-2') : insuredCol.classList.remove('col-span-2');
                const bathsCol = document.getElementById('field-baths');
                if(bathsCol) {
                    if(isTenant) { bathsCol.classList.remove('col-span-1'); bathsCol.classList.add('col-span-2'); } 
                    else { bathsCol.classList.remove('col-span-2'); bathsCol.classList.add('col-span-1'); }
                }
                const stdBtn = document.getElementById('btn-standard-updates');
                if(stdBtn) {
                    if(isTenant) { stdBtn.classList.remove('hidden'); stdBtn.querySelector('input').checked = false; } 
                    else { stdBtn.classList.add('hidden'); }
                }
                if (isTenant) {
                    console.log('üìù Loading Tenants form data...');
                    console.log('  blankTenant.customer:', this.blankTenant.customer);
                    console.log('  blankTenant.property:', this.blankTenant.property);
                    Binder.loadToDom('customer', this.blankTenant.customer, null);
                    Binder.renderToDom('customer', this.blankTenant.customer);
                    Binder.loadToDom('property', this.blankTenant.property, null);
                    Binder.renderToDom('property', this.blankTenant.property);
                    console.log('‚úÖ Tenants form data loaded to DOM');
                    const badge = document.getElementById('hud-prop-type-badge');
                    if(badge) badge.innerText = "Tenant - Rental - Apartment";
                    const radios = document.getElementsByName('consentRadios');
                    radios.forEach(r => { r.checked = (r.value === this.blankTenant.customer.consent); });
                } else {
                    this.refreshUI();
                }
            },
            toggleStandardUpdates: function(el) {
                // Implement your logic here for toggling standard updates.
                // This is a placeholder to avoid syntax/type errors.
            },
            setConsent: function(val) {
                if(this.viewMode === 'Tenants') this.blankTenant.customer.consent = val;
                else this.customer.consent = val;
            },
            deleteProperty: () => {
                if(App.properties.length <= 1) return;
                App.properties.splice(App.currPropIdx, 1);
                App.currPropIdx = 0;
                App.renderSelectors();
                App.refreshUI();
            }, 
            addNewProperty: () => {
                const newProp = { ...DataFactory.createDefaultProperty(), id: App.properties.length + 1 };
                App.properties.push(newProp);
                App.currPropIdx = App.properties.length - 1;
                App.renderSelectors();
                App.refreshUI();
            },
            saveToDatabase: async function() {
                console.log('üî• saveToDatabase CALLED! Current view mode:', this.viewMode);
                const btn = document.getElementById('btn-save');
                const originalText = btn.innerHTML;
                
                try {
                    // Show saving state
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
                    
                    // CRITICAL: Sync ALL form values for BOTH modes (Homeowners AND Tenants)
                    console.log('üîÑ Syncing ALL form values from DOM for both modes...');
                    
                    // Helper function to sync consent radio buttons
                    const syncConsent = () => {
                        const consentRadio = document.querySelector('input[name="consentRadios"]:checked');
                        return consentRadio ? consentRadio.value : '';
                    };
                    
                    // Sync the CURRENT active mode's data from DOM
                    if (this.viewMode === 'Homeowners') {
                        console.log('üè† Currently in Homeowners mode - syncing Homeowners data from DOM...');
                        
                        // Sync customer fields for Homeowners
                        document.querySelectorAll('.hud-scope[data-scope="customer"] [data-key]').forEach(el => {
                            const key = el.dataset.key;
                            if (el.type === 'checkbox') {
                                this.customer[key] = el.checked ? 'Yes' : 'No';
                            } else if (el.type === 'radio') {
                                if (el.checked) this.customer[key] = el.value;
                            } else {
                                this.customer[key] = el.value;
                            }
                        });
                        this.customer.consent = syncConsent();
                        
                        // Sync current property fields for Homeowners
                        const currentProp = this.properties[this.currPropIdx];
                        if (currentProp) {
                            document.querySelectorAll('.hud-scope[data-scope="property"] [data-key]').forEach(el => {
                                const key = el.dataset.key;
                                if (el.type === 'checkbox') {
                                    currentProp[key] = el.checked ? 'Yes' : 'No';
                                } else if (el.type === 'radio') {
                                    if (el.checked) currentProp[key] = el.value;
                                } else {
                                    currentProp[key] = el.value;
                                }
                            });
                        }
                        console.log('‚úÖ Synced Homeowners customer:', this.customer);
                        console.log('‚úÖ Synced Homeowners properties:', this.properties);
                        
                    } else {
                        console.log('üè¢ Currently in Tenants mode - syncing Tenants data from DOM...');
                        
                        // Sync customer fields for Tenants
                        document.querySelectorAll('.hud-scope[data-scope="customer"] [data-key]').forEach(el => {
                            const key = el.dataset.key;
                            if (el.type === 'checkbox') {
                                this.blankTenant.customer[key] = el.checked ? 'Yes' : 'No';
                            } else if (el.type === 'radio') {
                                if (el.checked) this.blankTenant.customer[key] = el.value;
                            } else {
                                this.blankTenant.customer[key] = el.value;
                            }
                        });
                        this.blankTenant.customer.consent = syncConsent();
                        
                        // Sync property fields for Tenants
                        document.querySelectorAll('.hud-scope[data-scope="property"] [data-key]').forEach(el => {
                            const key = el.dataset.key;
                            if (el.type === 'checkbox') {
                                this.blankTenant.property[key] = el.checked ? 'Yes' : 'No';
                            } else if (el.type === 'radio') {
                                if (el.checked) this.blankTenant.property[key] = el.value;
                            } else {
                                this.blankTenant.property[key] = el.value;
                            }
                        });
                        console.log('‚úÖ Synced Tenants customer:', this.blankTenant.customer);
                        console.log('‚úÖ Synced Tenants property:', this.blankTenant.property);
                    }
                    
                    // Now create the payload with both modes' data
                    const isTenantsMode = this.viewMode === 'Tenants';
                    const sourceCustomer = isTenantsMode ? this.blankTenant.customer : this.customer;
                    const sourceProperties = isTenantsMode ? [this.blankTenant.property] : this.properties;
                    
                    console.log('üíæ Save called in mode:', this.viewMode);
                    console.log('  isTenantsMode:', isTenantsMode);
                    console.log('  sourceCustomer:', sourceCustomer);
                    console.log('  sourceProperties length:', sourceProperties.length);
                    
                    // Get email from stored lead info if available, or from customer data
                    let email = '';
                    if (this.originalLead && this.originalLead.email) {
                        email = this.originalLead.email;
                    } else if (sourceCustomer && sourceCustomer.email) {
                        email = sourceCustomer.email;
                    }
                    
                    // Also get name and phone from original lead if customer name not set
                    const name = sourceCustomer.name || (this.originalLead?.name || '');
                    const phone = sourceCustomer.phone || (this.originalLead?.phone || '');
                    
                    console.log('üíæ Property save - email:', email, 'name:', name, 'phone:', phone, 'mode:', this.viewMode);
                    
                    if (!email) {
                        throw new Error('Email is required. Please search for a client first.');
                    }
                    
                    // Helper function to format property data
                    const formatPropertyData = (customer, properties) => ({
                        customer: {
                            name: customer.name || name,
                            address: customer.address,
                            city: customer.city,
                            postal: customer.postal,
                            phone: customer.phone || phone,
                            dob: customer.dob,
                            consent: customer.consent,
                            quoteType: customer.quoteType,
                            email: email
                        },
                        properties: properties.map(prop => ({
                            id: prop.id,
                            policyType: prop.policyType,
                            structure: prop.structure,
                            // Coverage
                            deductible: prop.deductible,
                            liability: prop.liability,
                            mortgageCount: prop.mortgageCount,
                            smokeFree: prop.smokeFree,
                            firstTimeBuyer: prop.firstTimeBuyer,
                            coverageType: prop.coverageType,
                            gbrc: prop.gbrc,
                            singleLimit: prop.singleLimit,
                            // Building Details
                            yearBuilt: prop.yearBuilt,
                            occupiedSince: prop.occupiedSince,
                            storeys: prop.storeys,
                            units: prop.units,
                            families: prop.families,
                            ownerOcc: prop.ownerOcc,
                            livingArea: prop.livingArea,
                            // Applicants
                            insDob: prop.insDob,
                            insGender: prop.insGender,
                            insuredPropertySince: prop.insuredPropertySince,
                            occupation: prop.occupation,
                            empStatus: prop.empStatus,
                            coDob: prop.coDob,
                            coGender: prop.coGender,
                            insuredSince: prop.insuredSince,
                            insuredBrokerageSince: prop.insuredBrokerageSince,
                            // Interior & Basement
                            fullBaths: prop.fullBaths,
                            halfBaths: prop.halfBaths,
                            bsmtArea: prop.bsmtArea,
                            bsmtFin: prop.bsmtFin,
                            bsmtFinBool: prop.bsmtFinBool,
                            sepEntrance: prop.sepEntrance,
                            bsmtRented: prop.bsmtRented,
                            // Systems
                            heatYear: prop.heatYear,
                            elecYear: prop.elecYear,
                            plumbYear: prop.plumbYear,
                            roofYear: prop.roofYear,
                            tankYear: prop.tankYear,
                            tankType: prop.tankType,
                            // Safety
                            burglar: prop.burglar,
                            fire: prop.fire,
                            sprinkler: prop.sprinkler,
                            sumpPump: prop.sumpPump,
                            fireExt: prop.fireExt,
                            smokeDet: prop.smokeDet,
                            // Additional
                            additionalNotes: prop.additionalNotes
                        }))
                    });
                    
                    // Prepare BOTH Homeowners and Tenants data for saving
                    const homeownersData = formatPropertyData(this.customer, this.properties);
                    const tenantsData = formatPropertyData(this.blankTenant.customer, [this.blankTenant.property]);
                    
                    // Prepare payload for backend (with BOTH modes)
                    const payload = {
                        email: email,
                        viewMode: this.viewMode, // Current view mode
                        homeowners: homeownersData,
                        tenants: tenantsData,
                        // Also include the old structure for backwards compatibility
                        customer: sourceCustomer.name ? formatPropertyData(sourceCustomer, sourceProperties).customer : homeownersData.customer,
                        properties: sourceProperties.length > 0 ? formatPropertyData(sourceCustomer, sourceProperties).properties : homeownersData.properties
                    };
                    
                    console.log("üíæ Saving BOTH Homeowners and Tenants data:", payload);
                    console.log("üìä Homeowners data:", homeownersData);
                    console.log("üìä Tenants data:", tenantsData);
                    
                    console.log("üì§ DETAILED PAYLOAD STRUCTURE:");
                    console.log("   email:", payload.email);
                    console.log("   viewMode:", payload.viewMode);
                    console.log("   homeowners.customer:", payload.homeowners?.customer ? 'YES ‚úÖ' : 'NO ‚ùå');
                    console.log("   homeowners.properties:", payload.homeowners?.properties ? `YES (${payload.homeowners.properties.length} items) ‚úÖ` : 'NO ‚ùå');
                    console.log("   tenants.customer:", payload.tenants?.customer ? 'YES ‚úÖ' : 'NO ‚ùå');
                    console.log("   tenants.properties:", payload.tenants?.properties ? `YES (${payload.tenants.properties.length} items) ‚úÖ` : 'NO ‚ùå');
                    
                    // Check if tenants data is actually populated
                    if (!payload.tenants?.customer || Object.keys(payload.tenants.customer).length === 0) {
                        console.warn("‚ö†Ô∏è WARNING: Tenants customer is empty!");
                    }
                    if (!payload.tenants?.properties || payload.tenants.properties.length === 0) {
                        console.warn("‚ö†Ô∏è WARNING: Tenants properties is empty!");
                    }
                    
                    console.log("üì§ Sending to backend...");
                    console.log("Payload JSON size:", JSON.stringify(payload).length, "bytes");
                    
                    // Send to backend
                    const response = await fetch(`${window.location.origin}/api/save-property`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log("‚úÖ Property data saved successfully:", result);
                        btn.className = "text-xs font-bold text-white bg-emerald-600 hover:bg-emerald-700 px-4 py-2.5 rounded-lg shadow-sm transition-all flex items-center gap-2 whitespace-nowrap focus:ring-2 focus:ring-emerald-500 focus:outline-none";
                        btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved Successfully';
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fa-solid fa-database"></i> Save';
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Failed to save');
                    }
                    
                } catch (error) {
                    console.error("‚ùå Error saving property data:", error);
                    btn.className = "text-xs font-bold text-white bg-rose-600 hover:bg-rose-700 px-4 py-2.5 rounded-lg shadow-sm transition-all flex items-center gap-2 whitespace-nowrap focus:ring-2 focus:ring-rose-500 focus:outline-none";
                    btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Save Failed';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.className = "text-xs font-bold text-white bg-emerald-600 hover:bg-emerald-700 px-4 py-2.5 rounded-lg shadow-sm transition-all flex items-center gap-2 whitespace-nowrap focus:ring-2 focus:ring-emerald-500 focus:outline-none";
                        btn.innerHTML = '<i class="fa-solid fa-database"></i> Save';
                    }, 2000);
                }
            },
            handleSearch: async (q) => {
                const res = document.getElementById('search-results');
                const term = (q || '').trim().toLowerCase();
                if (!term) {
                    res.classList.add('hidden');
                    res.innerHTML = '';
                    return;
                }

                res.classList.remove('hidden');
                res.innerHTML = '<div class="px-4 py-3 text-xs text-slate-500">Searching...</div>';

                try {
                    const response = await fetch(`${window.location.origin}/api/leads`);
                    const result = await response.json();

                    if (!result.data || !Array.isArray(result.data)) {
                        res.innerHTML = '<div class="px-4 py-3 text-xs text-rose-500">Error loading leads</div>';
                        return;
                    }

                    const matches = result.data.filter(lead => {
                        const name = (lead.name || '').toLowerCase();
                        const email = (lead.email || '').toLowerCase();
                        const phone = (lead.phone || '').toLowerCase();
                        return name.includes(term) || email.includes(term) || phone.includes(term);
                    });

                    if (matches.length === 0) {
                        res.innerHTML = '<div class="px-4 py-3 text-xs text-slate-500 text-center">No matching leads found</div>';
                        return;
                    }

                    res.innerHTML = matches.map((lead) => `
                        <div class="search-result-item px-4 py-2.5 hover:bg-indigo-50 cursor-pointer border-b border-slate-100 last:border-0 transition-colors"
                             data-name="${(lead.name || '').replace(/\"/g, '&quot;')}"
                             data-phone="${(lead.phone || '').replace(/\"/g, '&quot;')}"
                             data-email="${(lead.email || '').replace(/\"/g, '&quot;')}">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-bold text-slate-800">${lead.name || 'No Name'}</div>
                                    <div class="text-xs text-slate-500">${lead.email || 'No email'}</div>
                                </div>
                                <div class="text-xs font-mono text-slate-600">${lead.phone || ''}</div>
                            </div>
                        </div>
                    `).join('');

                    // Attach click handlers
                    setTimeout(() => {
                        document.querySelectorAll('.search-result-item').forEach(item => {
                            item.addEventListener('click', () => {
                                const name = item.getAttribute('data-name');
                                const phone = item.getAttribute('data-phone');
                                const email = item.getAttribute('data-email');
                                App.selectLead(name, phone, email);
                                res.classList.add('hidden');
                            });
                        });
                    }, 0);
                } catch (error) {
                    console.error('‚ùå Error searching leads:', error);
                    res.innerHTML = '<div class="px-4 py-3 text-xs text-rose-500">Error loading leads</div>';
                }
            },

            autoFillFromDASH: function() {
                console.log('üîÑ Auto-filling from selected driver data...');
                
                // Get the drivers data from localStorage
                const driversStr = localStorage.getItem('autoDashboardDrivers');
                const currDrvIdxStr = localStorage.getItem('autoDashboardCurrDrvIdx');
                
                if (!driversStr) {
                    alert('‚ùå No driver data found. Please parse a DASH PDF first in the Auto Dashboard.');
                    console.warn('No autoDashboardDrivers in localStorage');
                    return;
                }

                try {
                    const drivers = JSON.parse(driversStr);
                    const currDrvIdx = parseInt(currDrvIdxStr || '0');
                    const selectedDriver = drivers[currDrvIdx];
                    
                    if (!selectedDriver) {
                        alert('‚ùå Selected driver not found.');
                        console.warn('Selected driver not found at index:', currDrvIdx);
                        return;
                    }

                    console.log(`üìä Using Driver ${selectedDriver.id || (currDrvIdx + 1)} data:`, selectedDriver);

                    // Map driver fields to Property fields
                    const fieldMapping = {
                        'personalName': 'name',            // Customer Name
                        'personalAddress': 'address',      // Address
                        'personalDob': 'dob',              // Date of Birth
                        'personalMobile': 'phone'          // Phone
                    };

                    let filledCount = 0;
                    const filledFields = [];

                    // Auto-fill matching fields directly from selected driver data
                    Object.entries(fieldMapping).forEach(([drvKey, propKey]) => {
                        const drvValue = selectedDriver[drvKey];
                        if (drvValue && drvValue !== '-' && drvValue !== 'N/A' && drvValue !== '') {
                            const propInput = document.querySelector(`[data-key="${propKey}"]`);
                            if (propInput) {
                                propInput.value = drvValue;
                                
                                // Trigger input event to ensure data binding
                                propInput.dispatchEvent(new Event('input', { bubbles: true }));
                                propInput.dispatchEvent(new Event('change', { bubbles: true }));
                                
                                console.log(`‚úÖ Filled ${propKey}: "${drvValue}"`);
                                filledFields.push(`${propKey}: ${drvValue}`);
                                filledCount++;
                                
                                // Visual feedback - highlight the field
                                propInput.classList.add('ring-2', 'ring-indigo-400', 'bg-indigo-50');
                                setTimeout(() => {
                                    propInput.classList.remove('ring-2', 'ring-indigo-400', 'bg-indigo-50');
                                }, 2000);
                            }
                        }
                    });

                    if (filledCount > 0) {
                        const message = `‚úÖ Auto-filled ${filledCount} field(s) from Driver ${selectedDriver.id || (currDrvIdx + 1)} data:\n\n${filledFields.join('\n')}`;
                        console.log(message);
                        alert(message);
                    } else {
                        alert('‚ö†Ô∏è No matching data found to auto-fill.');
                    }

                } catch (error) {
                    console.error('‚ùå Error parsing DASH data:', error);
                    alert('‚ùå Error parsing DASH data. Please try again.');
                }
            },

        };

        window.addEventListener('DOMContentLoaded', () => {
            App.init();
            // --- Restore property data for current lead on load ---
            (async () => {
                // On load, if there is a lead in the URL or localStorage, select it
                const urlParams = new URLSearchParams(window.location.search);
                let name = urlParams.get('name') || '';
                let phone = urlParams.get('phone') || '';
                let email = urlParams.get('email') || '';
                if (!email) {
                    const savedOriginalLead = localStorage.getItem('autoDashboardOriginalLead');
                    if (savedOriginalLead) {
                        try {
                            const originalLead = JSON.parse(savedOriginalLead);
                            if (originalLead.email) email = originalLead.email;
                            if (originalLead.name) name = originalLead.name;
                            if (originalLead.phone) phone = originalLead.phone;
                        } catch (e) {}
                    }
                }
                if (email) {
                    await App.selectLead(name, phone, email);
                }
            })();

            // Attach nav button event listeners
            const navMap = [
                { id: 'btn-nav-client', section: 'card-client' },
                { id: 'btn-nav-applicants', section: 'card-applicants' },
                { id: 'btn-nav-coverage', section: 'card-coverage' },
                { id: 'btn-nav-property', section: 'card-property-systems' },
                { id: 'btn-nav-additional', section: 'card-additional' }
            ];
            navMap.forEach(({ id, section }) => {
                const btn = document.getElementById(id);
                if (btn) btn.addEventListener('click', () => App.scrollToSection(section));
            });
        });
    </script>
</body>
</html>